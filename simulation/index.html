<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photon-Semiconductor Interactions Virtual Lab</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.26.0/plotly.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
        }

        .card {
            transition: all 0.3s ease;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin: 20px;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .btn {
            transition: all 0.2s;
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            margin: 2px;
            font-size: 12px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #e879f9, #c084fc);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid #6366f1;
            color: #6366f1;
        }

        /* Lab Header */
        .lab-container {
            max-width: 100vw;
            margin: 0;
            padding: 0;
        }

        .lab-header {
            text-align: center;
            padding: 30px 20px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            margin-bottom: 0;
        }

        .lab-title {
            font-size: 2.8rem;
            font-weight: 700;
            margin-bottom: 15px;
            text-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .lab-subtitle {
            font-size: 1.3rem;
            opacity: 0.95;
            font-weight: 300;
        }

        /* Module Tabs */
        .module-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 0;
            gap: 0;
            flex-wrap: wrap;
            background: #f8fafc;
            border-bottom: 2px solid #e5e7eb;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .tab-btn {
            padding: 15px 30px;
            background: white;
            border: none;
            border-radius: 0;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            font-size: 15px;
            color: #6b7280;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            border-bottom: 3px solid #4f46e5;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .tab-btn:hover:not(.active) {
            background: #f3f4f6;
            color: #374151;
        }

        /* Module Content */
        .module-content {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .module-content.active {
            display: block;
        }

        .experiment-layout {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            height: 100vh;
            padding: 20px;
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
        }

        .controls-panel {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            order: 2;
            height: calc(100vh - 60px);
            overflow-y: auto;
            margin: 0;
        }

        .controls-panel h3 {
            font-size: 16px;
            margin-bottom: 15px;
            color: #374151;
            font-weight: 600;
        }

        .visualization-panel {
            background: white;
            border-radius: 16px;
            padding: 15px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            min-height: calc(100vh - 60px);
            order: 1;
            display: flex;
            flex-direction: column;
            margin: 0;
        }
        
        .visualization-panel h3 {
            margin: 0;
            padding: 10px 25px;
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-bottom: 1px solid #e5e7eb;
            font-size: 16px;
            color: #374151;
            font-weight: 600;
            border-radius: 16px 16px 0 0;
            margin: -15px -15px 15px -15px;
        }

        .control-group {
            margin-bottom: 12px;
            background: transparent;
            padding: 10px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease;
        }

        .control-group:hover {
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.1);
            border-color: #6366f1;
        }

        .control-label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            color: #374151;
            font-size: 13px;
        }

        .control-input {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .control-input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .slider-container {
            margin: 8px 0;
        }

        .slider {
            width: 100%;
            height: 10px;
            border-radius: 5px;
            background: #e5e7eb;
            outline: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .slider:hover {
            background: #d1d5db;
        }

        .slider::-webkit-slider-thumb {
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
            transition: all 0.3s ease;
        }

        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4);
        }

        /* Visualization Containers */
        .canvas-container {
            text-align: center;
            position: relative;
            width: 100%;
            margin: 10px 0;
            padding: 15px;
            flex: 1;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            overflow: visible;
        }

        .plot-container {
            background: white;
            border-radius: 12px;
            padding: 10px;
            margin: 6px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border: 1px solid #e5e7eb;
            height: 38vh;
            width: 100%;
        }

        .info-panel {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border-radius: 12px;
            padding: 12px;
            margin-top: 15px;
            border-left: 4px solid #0284c7;
            border: 1px solid #bae6fd;
            box-shadow: 0 4px 12px rgba(2, 132, 199, 0.1);
        }

        .info-title {
            font-weight: 700;
            color: #0c4a6e;
            margin-bottom: 6px;
            font-size: 0.9rem;
        }

        .info-text {
            color: #075985;
            font-size: 12px;
            line-height: 1.4;
        }
        
        /* Matching Challenge Styles */
        .matching-container {
            display: grid;
            grid-template-columns: 1fr 50px 1fr;
            gap: 20px;
            align-items: start;
            margin-bottom: 25px;
        }
        
        .matching-column {
            background: #f8fafc;
            border-radius: 8px;
            padding: 15px;
        }
        
        .matching-item {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            text-align: center;
        }
        
        .matching-item:hover {
            border-color: #6366f1;
            transform: translateX(5px);
        }
        
        .matching-item.selected {
            border-color: #6366f1;
            background: #eff6ff;
            transform: scale(1.02);
        }
        
        .matching-item.matched {
            border-color: #6366f1;
            background: #eff6ff;
            opacity: 0.9;
        }
        
        .matching-item.correct-match {
            border-color: #10b981;
            background: #f0fdf4;
        }
        
        .matching-item.incorrect-match {
            border-color: #ef4444;
            background: #fef2f2;
        }
        
        .matching-connections {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .connection-line {
            position: absolute;
            background: #6366f1;
            height: 3px;
            border-radius: 2px;
            opacity: 0.8;
            z-index: 1;
            transform-origin: left;
        }
        
        .matching-title {
            text-align: center;
            margin-bottom: 15px;
            font-weight: 600;
            color: #1f2937;
        }
        
        .explanation-panel {
            background: #f0f9ff;
            border: 1px solid #0284c7;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            display: none;
        }
        
        .explanation-panel.active {
            display: block;
            animation: slideDown 0.3s ease-out;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Band Diagram */
        .band-diagram {
            position: relative;
            height: 35vh;
            width: 100%;
            background: linear-gradient(135deg, 
                #0f172a 0%, 
                #1e293b 15%, 
                #334155 35%, 
                #475569 55%, 
                #64748b 75%, 
                #94a3b8 90%, 
                #e2e8f0 100%);
            border-radius: 12px;
            overflow: visible;
            box-shadow: inset 0 4px 12px rgba(0,0,0,0.2);
        }

        .energy-level {
            position: absolute;
            width: 90%;
            left: 5%;
            height: 8px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 4px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.3);
        }

        .valence-band {
            background: linear-gradient(90deg, 
                #7c2d12 0%, 
                #dc2626 20%, 
                #ef4444 50%, 
                #f87171 70%, 
                #dc2626 100%);
            border: 2px solid #991b1b;
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.5), 
                        inset 0 2px 4px rgba(255, 255, 255, 0.2);
        }

        .conduction-band {
            background: linear-gradient(90deg, 
                #1e3a8a 0%, 
                #1d4ed8 20%, 
                #3b82f6 50%, 
                #60a5fa 70%, 
                #1d4ed8 100%);
            border: 2px solid #1e40af;
            box-shadow: 0 6px 20px rgba(29, 78, 216, 0.5), 
                        inset 0 2px 4px rgba(255, 255, 255, 0.2);
        }

        .band-gap-label {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.95), rgba(139, 92, 246, 0.95));
            color: white;
            padding: 8px 16px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 700;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4), 
                        inset 0 2px 4px rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }

        .energy-axis {
            position: absolute;
            left: 3%;
            top: 10%;
            bottom: 10%;
            width: 4px;
            background: linear-gradient(to bottom, #fbbf24, #f59e0b, #d97706);
            border-radius: 2px;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.5);
        }

        .energy-axis::before {
            content: 'Energy';
            position: absolute;
            top: -25px;
            left: 12px;
            font-size: 13px;
            font-weight: 700;
            color: #f59e0b;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .energy-axis::after {
            content: '↑';
            position: absolute;
            top: -18px;
            left: -6px;
            font-size: 20px;
            color: #f59e0b;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        /* Animation Elements */
        .photon {
            position: absolute;
            width: 36px;
            height: 36px;
            background: radial-gradient(circle at 30% 30%, 
                #fde047 0%, 
                #fbbf24 30%, 
                #f59e0b 60%, 
                #d97706 100%);
            border-radius: 50%;
            border: 3px solid #f59e0b;
            box-shadow: 0 0 24px rgba(245, 158, 11, 0.8), 
                        inset 0 2px 4px rgba(255, 255, 255, 0.3);
            animation: photonMove 3s ease-in-out infinite;
            z-index: 10;
        }

        .photon::before {
            content: 'hν';
            position: absolute;
            top: -32px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            font-weight: bold;
            color: #f59e0b;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            background: rgba(255, 255, 255, 0.95);
            padding: 3px 8px;
            border-radius: 5px;
            border: 1px solid #f59e0b;
            white-space: nowrap;
        }

        @keyframes photonMove {
            0% { 
                left: -40px; 
                opacity: 0;
                transform: scale(0.8) rotate(0deg);
            }
            15% { 
                opacity: 1;
                transform: scale(1) rotate(90deg);
            }
            85% { 
                opacity: 1;
                transform: scale(1) rotate(270deg);
            }
            100% { 
                left: calc(100% + 40px); 
                opacity: 0;
                transform: scale(0.8) rotate(360deg);
            }
        }

        .electron {
            position: absolute;
            width: 20px;
            height: 20px;
            background: radial-gradient(circle at 30% 30%, 
                #60a5fa 0%, 
                #3b82f6 30%, 
                #1d4ed8 70%, 
                #1e3a8a 100%);
            border-radius: 50%;
            border: 2px solid #1e40af;
            transition: all 1s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 16px rgba(30, 64, 175, 0.6), 
                        inset 0 2px 4px rgba(255, 255, 255, 0.3);
            z-index: 15;
        }

        .electron::before {
            content: 'e⁻';
            position: absolute;
            top: -28px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            font-weight: bold;
            color: #1e40af;
            background: rgba(255, 255, 255, 0.95);
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid #1e40af;
        }

        .hole {
            position: absolute;
            width: 20px;
            height: 20px;
            background: radial-gradient(circle at 30% 30%, 
                #fecaca 0%, 
                #fca5a5 30%, 
                #f87171 70%, 
                #ef4444 100%);
            border: 3px solid #dc2626;
            border-radius: 50%;
            transition: all 1s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 16px rgba(220, 38, 38, 0.6), 
                        inset 0 2px 4px rgba(255, 255, 255, 0.4);
            z-index: 15;
        }

        .hole::before {
            content: 'h⁺';
            position: absolute;
            top: -28px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            font-weight: bold;
            color: #dc2626;
            background: rgba(255, 255, 255, 0.95);
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid #dc2626;
        }

        .absorption-event {
            position: absolute;
            width: 48px;
            height: 48px;
            border: 4px solid #fbbf24;
            border-radius: 50%;
            opacity: 0;
            animation: absorptionPulse 1.5s ease-out;
            z-index: 20;
        }

        @keyframes absorptionPulse {
            0% {
                opacity: 1;
                transform: scale(0.2);
                border-color: #fde047;
                box-shadow: 0 0 24px rgba(253, 224, 71, 0.8);
            }
            30% {
                opacity: 0.9;
                transform: scale(0.7);
                border-color: #fbbf24;
                box-shadow: 0 0 36px rgba(251, 191, 36, 0.9);
            }
            70% {
                opacity: 0.7;
                transform: scale(1.4);
                border-color: #f59e0b;
                box-shadow: 0 0 48px rgba(245, 158, 11, 0.7);
            }
            100% {
                opacity: 0;
                transform: scale(2.2);
                border-color: #d97706;
                box-shadow: 0 0 72px rgba(217, 119, 6, 0.5);
            }
        }

        /* Emission Timeline */
        .emission-timeline {
            height: 35vh;
            width: 100%;
            position: relative;
            background: linear-gradient(135deg, #1e293b 0%, #334155 20%, #475569 40%, #64748b 60%, #94a3b8 80%, #e2e8f0 100%);
            border-radius: 12px;
            overflow: visible;
            box-shadow: inset 0 4px 12px rgba(0,0,0,0.2);
        }

        /* Simulation Legend Styles - Redesigned for Space Efficiency */
        .simulation-legend {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            font-size: 10px;
            z-index: 25;
            max-width: 200px;
            min-width: 180px;
            backdrop-filter: blur(8px);
            transition: all 0.3s ease;
            transform: translateX(100%);
            opacity: 0;
        }

        .simulation-legend.visible {
            transform: translateX(0);
            opacity: 1;
        }

        .simulation-legend.collapsed {
            transform: translateX(calc(100% - 40px));
            opacity: 0.8;
        }

        .legend-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 1px solid #e5e7eb;
        }

        .legend-title {
            font-weight: 600;
            color: #374151;
            font-size: 11px;
            flex: 1;
        }

        .legend-collapse-btn {
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            font-size: 12px;
            padding: 2px;
            border-radius: 3px;
            transition: all 0.2s;
        }

        .legend-collapse-btn:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .legend-content {
            max-height: 300px;
            overflow-y: auto;
        }

        .legend-section {
            margin-bottom: 10px;
        }

        .legend-section-title {
            font-weight: 600;
            color: #6366f1;
            font-size: 10px;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            gap: 8px;
            min-height: 16px;
        }

        .legend-item:last-child {
            margin-bottom: 0;
        }

        .legend-symbol {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            font-weight: bold;
            color: white;
            min-width: 16px;
            position: relative;
        }

        .legend-symbol.photon {
            background: radial-gradient(circle, #fbbf24 30%, #f59e0b 70%);
            border: 1px solid #f59e0b;
            animation: legendPhotonPulse 2s infinite;
        }

        .legend-symbol.electron {
            background: radial-gradient(circle, #3b82f6 30%, #1d4ed8 70%);
            border: 1px solid #1d4ed8;
        }

        .legend-symbol.hole {
            background: radial-gradient(circle, #ef4444 30%, #dc2626 70%);
            border: 1px solid #dc2626;
        }

        .legend-symbol.absorption {
            background: radial-gradient(circle, #f59e0b 30%, #d97706 70%);
            border: 1px solid #d97706;
            animation: legendAbsorptionFlash 3s infinite;
        }

        .legend-symbol.emission {
            background: radial-gradient(circle, #10b981 30%, #059669 70%);
            border: 1px solid #059669;
            animation: legendEmissionGlow 2s infinite alternate;
        }

        .legend-symbol.band {
            background: linear-gradient(45deg, #6366f1, #8b5cf6);
            border: 1px solid #6366f1;
            border-radius: 3px;
        }

        .legend-symbol.trap {
            background: radial-gradient(circle, #f59e0b 30%, #d97706 70%);
            border: 1px solid #d97706;
            border-radius: 2px;
            animation: legendTrapBlink 3s infinite;
        }

        @keyframes legendPhotonPulse {
            0%, 100% { box-shadow: 0 0 4px rgba(251, 191, 36, 0.4); }
            50% { box-shadow: 0 0 8px rgba(251, 191, 36, 0.8); }
        }

        @keyframes legendAbsorptionFlash {
            0%, 85%, 100% { opacity: 1; }
            90%, 95% { opacity: 0.4; }
        }

        @keyframes legendEmissionGlow {
            from { box-shadow: 0 0 2px rgba(16, 185, 129, 0.4); }
            to { box-shadow: 0 0 6px rgba(16, 185, 129, 0.8); }
        }

        @keyframes legendTrapBlink {
            0%, 100% { opacity: 0.7; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
        }

        .legend-text {
            color: #374151;
            line-height: 1.2;
            font-size: 10px;
            flex: 1;
        }

        .legend-physics {
            font-size: 8px;
            color: #6b7280;
            margin-top: 1px;
            font-style: italic;
        }

        .legend-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            z-index: 30;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
        }

        .legend-toggle:hover {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }

        .legend-toggle.active {
            background: linear-gradient(135deg, #059669, #047857);
        }

        /* Quick Info Panel - Compact Alternative */
        .quick-info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 10px;
            max-width: 200px;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 20;
        }

        .quick-info.visible {
            opacity: 1;
        }

        .quick-info-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: #fbbf24;
        }

        /* Legend Pills - Alternative Compact Design */
        .legend-pills {
            position: absolute;
            bottom: 15px;
            right: 15px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            z-index: 25;
        }

        .legend-pill {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 4px 8px;
            font-size: 9px;
            display: flex;
            align-items: center;
            gap: 6px;
            backdrop-filter: blur(5px);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .legend-pill:hover {
            background: rgba(255, 255, 255, 1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .pill-icon {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .pill-text {
            color: #374151;
            font-weight: 500;
        }

        .energy-level-emission {
            position: absolute;
            width: 85%;
            left: 7.5%;
            height: 6px;
            border-radius: 3px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .conduction-level {
            background: linear-gradient(90deg, #1d4ed8, #3b82f6, #1d4ed8);
            border: 1px solid #1e40af;
            top: 18%;
        }

        .valence-level {
            background: linear-gradient(90deg, #dc2626, #ef4444, #dc2626);
            border: 1px solid #b91c1c;
            bottom: 18%;
        }

        .trap-level {
            background: linear-gradient(90deg, #d97706, #f59e0b, #d97706);
            border: 1px solid #b45309;
            top: 58%;
            width: 60%;
            left: 20%;
        }

        .excited-carrier {
            position: absolute;
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, #3b82f6, #1e40af);
            border-radius: 50%;
            border: 2px solid #1d4ed8;
            animation: carrierFloat 2.5s ease-in-out infinite;
            box-shadow: 0 0 16px rgba(59, 130, 246, 0.6);
            z-index: 15;
        }

        .excited-carrier::before {
            content: 'e*';
            position: absolute;
            top: -26px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            font-weight: bold;
            color: #3b82f6;
            background: rgba(255, 255, 255, 0.95);
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid #3b82f6;
        }

        .excited-carrier.hot {
            background: radial-gradient(circle, #f59e0b, #d97706);
            border-color: #f59e0b;
            animation: hotCarrierFloat 1.8s ease-in-out infinite;
        }

        .excited-carrier.hot::before {
            content: 'e*hot';
            color: #f59e0b;
            border-color: #f59e0b;
        }

        .excited-carrier.trapped {
            background: radial-gradient(circle, #8b5cf6, #7c3aed);
            border-color: #8b5cf6;
            animation: trappedCarrierBlink 3s ease-in-out infinite;
        }

        .excited-carrier.trapped::before {
            content: 'e*T';
            color: #8b5cf6;
            border-color: #8b5cf6;
        }

        @keyframes carrierFloat {
            0%, 100% { transform: translateY(0px) scale(1); }
            50% { transform: translateY(-10px) scale(1.1); }
        }

        @keyframes hotCarrierFloat {
            0%, 100% { transform: translateY(0px) scale(1) rotate(0deg); }
            25% { transform: translateY(-5px) scale(1.15) rotate(90deg); }
            75% { transform: translateY(-5px) scale(1.15) rotate(270deg); }
        }

        @keyframes trappedCarrierBlink {
            0%, 100% { opacity: 0.6; transform: scale(0.9); }
            50% { opacity: 1; transform: scale(1.1); }
        }

        .phonon {
            position: absolute;
            width: 12px;
            height: 12px;
            background: radial-gradient(circle, #6b7280, #4b5563);
            border-radius: 50%;
            border: 1px solid #6b7280;
            animation: phononVibrate 1.5s ease-in-out infinite;
            z-index: 8;
        }

        .phonon::before {
            content: '♪';
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: #6b7280;
        }

        @keyframes phononVibrate {
            0%, 100% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.2) rotate(90deg); }
            75% { transform: scale(1.2) rotate(270deg); }
        }

        .energy-transfer {
            position: absolute;
            width: 4px;
            height: 40px;
            background: linear-gradient(to bottom, #fbbf24, transparent);
            animation: energyFlow 2s ease-out;
            z-index: 12;
        }

        @keyframes energyFlow {
            0% { height: 0px; opacity: 1; }
            100% { height: 40px; opacity: 0; }
        }

        .recombination-zone {
            position: absolute;
            border: 3px dashed #10b981;
            border-radius: 50%;
            opacity: 0;
            animation: zoneExpand 2.5s ease-out;
            z-index: 6;
        }

        @keyframes zoneExpand {
            0% {
                opacity: 1;
                width: 16px;
                height: 16px;
            }
            50% {
                opacity: 0.8;
                width: 50px;
                height: 50px;
            }
            100% {
                opacity: 0;
                width: 80px;
                height: 80px;
            }
        }

        .quantum-dot-indicator {
            position: absolute;
            width: 8px;
            height: 8px;
            background: radial-gradient(circle, #8b5cf6, #6d28d9);
            border-radius: 50%;
            animation: quantumBlink 2s ease-in-out infinite;
            z-index: 7;
        }

        @keyframes quantumBlink {
            0%, 100% { opacity: 0.4; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.5); box-shadow: 0 0 12px #8b5cf6; }
        }

        .process-indicator {
            position: absolute;
            top: 10px;
            left: 15px;
            background: rgba(255,255,255,0.95);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            border: 2px solid;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 25;
        }

        .process-radiative {
            color: #059669;
            border-color: #059669;
        }

        .process-nonradiative {
            color: #dc2626;
            border-color: #dc2626;
        }

        .process-mixed {
            color: #f59e0b;
            border-color: #f59e0b;
        }

        /* Enhanced Information Panels */
        .detailed-info-panel {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border-radius: 16px;
            padding: 20px;
            margin-top: 20px;
            border-left: 4px solid #0284c7;
            border: 1px solid #bae6fd;
            box-shadow: 0 8px 24px rgba(2, 132, 199, 0.1);
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .info-metric {
            background: rgba(255, 255, 255, 0.8);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(2, 132, 199, 0.2);
        }

        .info-metric-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: #0c4a6e;
        }

        .info-metric-label {
            font-size: 0.8rem;
            color: #075985;
            margin-top: 4px;
            font-weight: 500;
        }

        .physics-explanation {
            background: #fef3c7;
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
            border-left: 4px solid #f59e0b;
            font-size: 11px;
            line-height: 1.4;
        }

        .physics-explanation-title {
            font-weight: 600;
            color: #92400e;
            margin-bottom: 6px;
        }

        .mechanism-flow {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 15px 0;
            padding: 10px;
            background: rgba(99, 102, 241, 0.1);
            border-radius: 8px;
        }

        .flow-step {
            flex: 1;
            text-align: center;
            font-size: 11px;
            color: #4338ca;
            font-weight: 500;
        }

        .flow-arrow {
            color: #6366f1;
            font-size: 16px;
            margin: 0 8px;
        }

        .photon-emission {
            position: absolute;
            width: 28px;
            height: 28px;
            background: radial-gradient(circle, #10b981 30%, #059669 70%, #047857 100%);
            border-radius: 50%;
            border: 2px solid #10b981;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.8);
            animation: photonEmit 2s ease-out;
            z-index: 16;
        }

        .photon-emission::before {
            content: 'hν';
            position: absolute;
            top: -24px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            font-weight: bold;
            color: #10b981;
            background: rgba(255, 255, 255, 0.95);
            padding: 2px 5px;
            border-radius: 3px;
            border: 1px solid #10b981;
        }

        @keyframes photonEmit {
            0% {
                opacity: 1;
                transform: scale(0.5) rotate(0deg);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.4) rotate(180deg);
            }
            100% {
                opacity: 0;
                transform: scale(2.5) translateY(-50px) rotate(360deg);
            }
        }

        .emission-type-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255,255,255,0.95);
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            border: 2px solid;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .fluorescence-indicator {
            color: #0891b2;
            border-color: #0891b2;
        }

        .phosphorescence-indicator {
            color: #7c3aed;
            border-color: #7c3aed;
        }

        .led-indicator {
            color: #dc2626;
            border-color: #dc2626;
        }

        /* Status Display */
        .status-display {
            display: flex;
            justify-content: space-around;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
            border-radius: 16px;
            padding: 20px;
            margin: 12px 0;
            border: 1px solid rgba(99, 102, 241, 0.2);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.1);
        }

        .status-item {
            text-align: center;
        }

        .status-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #6366f1;
            text-shadow: 0 2px 4px rgba(99, 102, 241, 0.2);
        }

        .status-label {
            font-size: 0.85rem;
            color: #6b7280;
            text-transform: uppercase;
            font-weight: 600;
            margin-top: 4px;
        }

        /* Preset Sections */
        .preset-section {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }

        .preset-section h4 {
            color: #374151;
            font-size: 14px;
            margin-bottom: 10px;
            text-align: center;
            font-weight: 600;
        }

        .preset-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .btn-preset {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            padding: 10px 8px;
            font-size: 0.85rem;
            margin: 2px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-weight: 600;
            width: 100%;
            min-height: 45px;
        }
        
        .btn-preset span {
            font-size: 1.1rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
        }

        .btn-preset:hover {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }

        /* Challenge System Styles */
        .challenge-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
        }

        .challenge-section {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }

        .challenge-header {
            display: flex;
            align-items: flex-start;
            gap: 20px;
            margin-bottom: 25px;
        }

        .challenge-icon {
            font-size: 2.2rem;
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.3);
        }

        .challenge-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
            margin: 0;
        }

        .challenge-description {
            color: #6b7280;
            margin-bottom: 25px;
            line-height: 1.6;
            font-size: 1.1rem;
        }

        .challenge-stats {
            display: flex;
            justify-content: space-around;
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 35px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #6366f1;
            text-shadow: 0 2px 4px rgba(99, 102, 241, 0.2);
        }

        .stat-label {
            color: #6b7280;
            font-size: 0.95rem;
            margin-top: 8px;
            font-weight: 600;
        }

        .challenge-progress {
            background: #f3f4f6;
            border-radius: 12px;
            height: 12px;
            margin-bottom: 25px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .challenge-progress-bar {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            height: 100%;
            transition: width 0.5s ease;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
        }

        /* Quiz Styles */
        .quiz-question {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #6366f1;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }

        .quiz-question h4 {
            margin: 0 0 15px 0;
            color: #1f2937;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .quiz-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }

        .quiz-option {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-weight: 500;
        }

        .quiz-option:hover {
            border-color: #6366f1;
            background: #f8fafc;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
        }

        .quiz-option.selected {
            border-color: #6366f1;
            background: #eff6ff;
            color: #1e40af;
        }

        .quiz-option.correct {
            border-color: #10b981;
            background: #f0fdf4;
            color: #065f46;
        }

        .quiz-option.incorrect {
            border-color: #ef4444;
            background: #fef2f2;
            color: #991b1b;
        }

        /* Challenge Controls */
        .challenge-controls {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        .challenge-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }

        .challenge-btn-primary {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
        }

        .challenge-btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 2px solid #e5e7eb;
        }

        .challenge-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        .challenge-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .challenge-feedback {
            margin-top: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            font-weight: 500;
            display: none;
        }

        .challenge-feedback.success {
            background: #f0fdf4;
            color: #065f46;
            border: 1px solid #10b981;
            display: block;
        }

        .challenge-feedback.error {
            background: #fef2f2;
            color: #991b1b;
            border: 1px solid #ef4444;
            display: block;
        }

        /* Floating action buttons & panels */
        .floating-button {
            position: fixed;
            width: 3.5rem;
            height: 3.5rem;
            border-radius: 50%;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .floating-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 14px rgba(0,0,0,0.25);
        }

        .floating-button:active {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .floating-button.primary {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            bottom: 2rem;
            right: 2rem;
        }

        .floating-button.tour {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            bottom: 6.5rem;
            right: 2rem;
        }

        .floating-panel {
            position: fixed;
            max-width: 18rem;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            z-index: 99;
            bottom: 7rem;
            right: 2rem;
            transform-origin: bottom right;
            transform: scale(0);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 1.5rem;
        }

        .floating-panel.active {
            transform: scale(1);
            opacity: 1;
        }

        .floating-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .floating-panel-close {
            cursor: pointer;
            color: #6b7280;
            width: 1.5rem;
            height: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .floating-panel-content {
            max-height: calc(80vh - 3rem);
            overflow-y: auto;
        }

        .panel-title {
            font-weight: 600;
            font-size: 1.1rem;
            color: #1f2937;
            margin: 0;
        }

        /* GUIDED TOUR STYLES */
        .tour-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: transparent;
            z-index: 200;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease, background 0.5s ease;
        }

        .tour-overlay.active {
            opacity: 1;
            pointer-events: none;
        }

        .tour-spotlight {
            position: absolute;
            border-radius: 50%;
            box-shadow: 0 0 0 99999px rgba(0, 0, 0, 0);
            pointer-events: none;
            animation: spotlight-pulse 2s infinite alternate;
            z-index: 201;
            border: 2px dashed rgba(99, 102, 241, 0.7);
        }

        @keyframes spotlight-pulse {
            0% {
                box-shadow: 0 0 0 99999px rgba(0, 0, 0, 0);
                border-color: rgba(99, 102, 241, 0.7);
            }
            100% {
                box-shadow: 0 0 0 99999px rgba(0, 0, 0, 0);
                border-color: rgba(139, 92, 246, 0.9);
            }
        }

        .tour-spotlight-secondary {
            position: absolute;
            border-radius: 4px;
            box-shadow: 0 0 0 99999px rgba(0, 0, 0, 0);
            pointer-events: none;
            animation: secondary-pulse 2s infinite alternate;
            z-index: 201;
            border: 2px dashed rgba(139, 92, 246, 0.7);
        }

        @keyframes secondary-pulse {
            0% {
                box-shadow: 0 0 0 99999px rgba(0, 0, 0, 0);
                border-color: rgba(139, 92, 246, 0.7);
            }
            100% {
                box-shadow: 0 0 0 99999px rgba(0, 0, 0, 0);
            }
        }

        .tour-popup {
            position: fixed;
            width: 360px;
            max-width: 90vw;
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.25);
            z-index: 202;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            opacity: 0;
            pointer-events: none;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .tour-popup.active {
            opacity: 1;
            pointer-events: auto;
            transform: translate(-50%, -50%) scale(1);
        }

        .tour-header {
            margin-bottom: 15px;
        }

        .tour-step-number {
            font-size: 0.8rem;
            color: #6366f1;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .tour-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #1f2937;
        }

        .tour-content {
            color: #4b5563;
            line-height: 1.6;
            margin-bottom: 20px;
            font-size: 0.95rem;
        }

        .tour-challenge {
            background: #f0f9ff;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #0284c7;
        }

        .tour-challenge-title {
            font-weight: 600;
            color: #0c4a6e;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
        }

        .tour-challenge-title i {
            margin-right: 6px;
        }

        .tour-challenge-content {
            color: #075985;
        }

        .tour-progress {
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .tour-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #6366f1, #8b5cf6);
            border-radius: 2px;
            transition: width 0.5s ease;
        }

        .tour-controls {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .tour-btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .tour-btn-primary {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
        }

        .tour-btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .tour-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .tour-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .tour-score {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            z-index: 190;
            transform: translateY(-150%);
            opacity: 0;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            width: 180px;
        }

        .tour-score.active {
            transform: translateY(0);
            opacity: 1;
        }

        .tour-score-title {
            font-weight: 700;
            color: #6366f1;
            margin-bottom: 10px;
            font-size: 0.9rem;
            text-align: center;
        }

        .tour-score-item {
            font-size: 0.85rem;
            color: #4b5563;
            margin-bottom: 6px;
        }

        .tour-achievements {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            z-index: 250;
            text-align: center;
            opacity: 0;
            pointer-events: none;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            max-width: 90vw;
            width: 300px;
        }

        .tour-achievements.active {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
            pointer-events: all;
        }

        .achievement-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            animation: popIn 0.5s ease-out;
        }

        .achievement-title {
            font-weight: 700;
            font-size: 1.2rem;
            color: #1f2937;
            margin-bottom: 10px;
        }

        .achievement-description {
            color: #4b5563;
            margin-bottom: 20px;
            font-size: 0.95rem;
        }

        .highlight-element {
            position: relative;
            animation: pulse-highlight 2s infinite;
        }

        .challenge-success {
            animation: popIn 0.5s ease-out;
        }

        .info-tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }

        .info-tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: #374151;
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8rem;
            font-weight: normal;
        }

        .info-tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        @keyframes slideInRight {
            0% {
                transform: translateX(50px);
                opacity: 0;
            }
            100% {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes popIn {
            0% {
                transform: scale(0.6);
                opacity: 0;
            }
            70% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes pulse-highlight {
            0% {
                box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4);
            }
            70% {
                box-shadow: 0 0 0 8px rgba(99, 102, 241, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(99, 102, 241, 0);
            }
        }

        /* Animation Classes */
        .fade-in {
            animation: fadeIn 0.6s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .experiment-layout {
                grid-template-columns: 1fr;
                gap: 15px;
                height: auto;
                padding: 15px;
            }
            
            .controls-panel {
                order: 1;
                height: auto;
            }
            
            .visualization-panel {
                order: 2;
                min-height: 80vh;
            }
            
            .lab-title {
                font-size: 2.2rem;
            }
            
            .module-tabs {
                flex-direction: column;
            }
            
            .tab-btn {
                padding: 12px 20px;
            }
            
            .plot-container {
                height: 35vh;
            }
            
            .band-diagram, .emission-timeline {
                height: 32vh;
            }
            
            .challenge-container {
                padding: 20px;
            }
            
            .quiz-options {
                grid-template-columns: 1fr;
            }
            
            /* Mobile legend positioning */
            .simulation-legend {
                position: fixed;
                top: 60px;
                right: 10px;
                max-width: 160px;
                min-width: 150px;
                z-index: 40;
                font-size: 9px;
            }
            
            .legend-toggle {
                position: fixed;
                top: 60px;
                right: 10px;
                z-index: 45;
                width: 24px;
                height: 24px;
                font-size: 11px;
            }
            
            .quick-info {
                position: fixed;
                bottom: 60px;
                left: 10px;
                max-width: 160px;
                font-size: 9px;
            }
        }
    </style>
</head>
<body>
    <div class="lab-container">
        <!-- Module Tabs -->
        <div class="module-tabs">
            <div class="tab-btn active" onclick="switchModule(0)">
                <i class="fas fa-atom"></i> Quantum Absorption
            </div>
            <div class="tab-btn" onclick="switchModule(1)">
                <i class="fas fa-lightbulb"></i> Carrier Dynamics
            </div>
            <div class="tab-btn" onclick="switchModule(2)">
                <i class="fas fa-trophy"></i> Knowledge Challenges
            </div>
        </div>

        <!-- Module 1: Quantum Absorption -->
        <div class="module-content active" id="module-0">
            <div class="experiment-layout">
                <div class="visualization-panel">
                    <h3><i class="fas fa-chart-line"></i> Band Structure & Absorption Dynamics</h3>
                    <div class="canvas-container">
                        <div class="band-diagram" id="bandDiagram">
                            <div class="energy-level conduction-band" id="conductionBand"></div>
                            <div class="energy-level valence-band" id="valenceBand"></div>
                        </div>
                    </div>
                    
                    <div class="canvas-container">
                        <div id="absorptionPlot" class="plot-container"></div>
                    </div>
                </div>

                <div class="controls-panel">
                    <h3><i class="fas fa-sliders-h"></i> Quantum Parameters</h3>
                    
                    <div class="preset-section">
                        <h4><i class="fas fa-microchip"></i> Material Library</h4>
                        <div class="preset-grid">
                            <button class="btn-preset" onclick="applyAbsorptionPreset('si')">
                                <span>⚡</span> Silicon
                            </button>
                            <button class="btn-preset" onclick="applyAbsorptionPreset('gaas')">
                                <span>💎</span> GaAs
                            </button>
                            <button class="btn-preset" onclick="applyAbsorptionPreset('ge')">
                                <span>🔶</span> Germanium
                            </button>
                            <button class="btn-preset" onclick="applyAbsorptionPreset('inp')">
                                <span>🌟</span> InP
                            </button>
                            <button class="btn-preset" onclick="applyAbsorptionPreset('ingaas')">
                                <span>📡</span> InGaAs
                            </button>
                            <button class="btn-preset" onclick="applyAbsorptionPreset('algaas')">
                                <span>🔋</span> AlGaAs
                            </button>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label class="control-label"><i class="fas fa-atom"></i> Semiconductor Material</label>
                        <select class="control-input" id="material" onchange="updateAbsorption()">
                            <option value="si">Silicon (Si) - Indirect Bandgap</option>
                            <option value="gaas">Gallium Arsenide (GaAs) - Direct Bandgap</option>
                            <option value="ge">Germanium (Ge) - Indirect Bandgap</option>
                            <option value="inp">Indium Phosphide (InP) - Direct Bandgap</option>
                            <option value="ingaas">InGaAs - Direct Bandgap</option>
                            <option value="algaas">AlGaAs - Direct Bandgap</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label class="control-label"><i class="fas fa-thermometer-half"></i> Temperature: <span id="tempValue">300</span> K</label>
                        <div class="slider-container">
                            <input type="range" class="slider" id="temperature" min="77" max="400" value="300" oninput="updateTemperature()">
                        </div>
                    </div>

                    <div class="control-group">
                        <label class="control-label"><i class="fas fa-lightbulb"></i> Photon Energy: <span id="energyValue">1.5</span> eV</label>
                        <div class="slider-container">
                            <input type="range" class="slider" id="photonEnergy" min="0.5" max="4.0" step="0.05" value="1.5" oninput="updatePhotonEnergy()">
                        </div>
                    </div>

                    <div class="control-group">
                        <label class="control-label"><i class="fas fa-gem"></i> Crystal Quality: <span id="qualityValue">High</span></label>
                        <div class="slider-container">
                            <input type="range" class="slider" id="crystalQuality" min="1" max="10" value="8" oninput="updateQuality()">
                        </div>
                    </div>

                    <div style="margin-top: 20px; display: flex; flex-wrap: wrap; gap: 8px;">
                        <button class="btn btn-primary" onclick="animateAbsorption()">
                            <i class="fas fa-play"></i> Simulate
                        </button>
                        <button class="btn btn-secondary" onclick="startContinuousAnimation()">
                            <i class="fas fa-sync"></i> Continuous
                        </button>
                        <button class="btn btn-outline" onclick="resetAbsorption()">
                            <i class="fas fa-undo"></i> Reset
                        </button>
                    </div>

                    <div class="info-panel">
                        <div class="info-title"><i class="fas fa-info-circle"></i> Absorption Analysis</div>
                        <div class="info-text" id="absorptionInfo">
                            Select parameters to analyze photon-semiconductor interactions and quantum efficiency.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Module 2: Carrier Dynamics -->
        <div class="module-content" id="module-1">
            <div class="experiment-layout">
                <div class="visualization-panel">
                    <h3><i class="fas fa-wave-square"></i> Carrier Recombination Dynamics</h3>
                    <div class="canvas-container">
                        <div class="emission-timeline" id="emissionTimeline">
                            <div class="energy-level-emission conduction-level" id="conductionLevel"></div>
                            <div class="energy-level-emission trap-level" id="trapLevel"></div>
                            <div class="energy-level-emission valence-level" id="valenceLevel"></div>
                            <div class="emission-type-indicator fluorescence-indicator" id="emissionIndicator">Fluorescence</div>
                        </div>
                    </div>
                    
                    <div class="canvas-container">
                        <div id="lifetimePlot" class="plot-container"></div>
                    </div>

                    <div class="status-display">
                        <div class="status-item">
                            <div class="status-value" id="currentIntensity">0</div>
                            <div class="status-label">Intensity (%)</div>
                        </div>
                        <div class="status-item">
                            <div class="status-value" id="currentLifetime">1.0</div>
                            <div class="status-label">Lifetime (μs)</div>
                        </div>
                        <div class="status-item">
                            <div class="status-value" id="quantumEfficiency">0</div>
                            <div class="status-label">Quantum Eff. (%)</div>
                        </div>
                        <div class="status-item">
                            <div class="status-value" id="peakWavelength">520</div>
                            <div class="status-label">λ_peak (nm)</div>
                        </div>
                    </div>
                </div>

                <div class="controls-panel">
                    <h3><i class="fas fa-cogs"></i> Emission Control</h3>
                    
                    <div class="preset-section">
                        <h4><i class="fas fa-palette"></i> Emission Modes</h4>
                        <div class="preset-grid">
                            <button class="btn-preset" onclick="applyEmissionPreset('fluorescence')">
                                <span>💫</span> Fluorescence
                            </button>
                            <button class="btn-preset" onclick="applyEmissionPreset('phosphorescence')">
                                <span>🌙</span> Phosphorescence
                            </button>
                            <button class="btn-preset" onclick="applyEmissionPreset('led')">
                                <span>💡</span> LED
                            </button>
                            <button class="btn-preset" onclick="applyEmissionPreset('quantum_dots')">
                                <span>🔬</span> Quantum Dots
                            </button>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label class="control-label"><i class="fas fa-radiation"></i> Emission Type</label>
                        <select class="control-input" id="emissionType" onchange="updateEmission()">
                            <option value="fluorescence">Fluorescence (Fast Direct)</option>
                            <option value="phosphorescence">Phosphorescence (Slow Trap-Mediated)</option>
                            <option value="led">LED Electroluminescence</option>
                            <option value="quantum_dots">Quantum Dots Confined</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label class="control-label"><i class="fas fa-bolt"></i> Excitation Power: <span id="excitationValue">50</span>%</label>
                        <div class="slider-container">
                            <input type="range" class="slider" id="excitationPower" min="0" max="100" value="50" oninput="updateExcitation()">
                        </div>
                    </div>

                    <div class="control-group">
                        <label class="control-label"><i class="fas fa-clock"></i> Carrier Lifetime: <span id="lifetimeValue">1.0</span> μs</label>
                        <div class="slider-container">
                            <input type="range" class="slider" id="carrierLifetime" min="0.01" max="100" step="0.01" value="1.0" oninput="updateLifetime()">
                        </div>
                    </div>

                    <div class="control-group">
                        <label class="control-label"><i class="fas fa-thermometer-half"></i> Temperature: <span id="emissionTempValue">300</span> K</label>
                        <div class="slider-container">
                            <input type="range" class="slider" id="emissionTemperature" min="77" max="400" value="300" oninput="updateEmissionTemp()">
                        </div>
                    </div>

                    <div style="margin-top: 20px; display: flex; flex-wrap: wrap; gap: 8px;">
                        <button class="btn btn-primary" onclick="startEmission()">
                            <i class="fas fa-power-off"></i> Start
                        </button>
                        <button class="btn btn-secondary" onclick="pulseExcitation()">
                            <i class="fas fa-pulse"></i> Pulse
                        </button>
                        <button class="btn btn-outline" onclick="stopEmission()">
                            <i class="fas fa-stop"></i> Stop
                        </button>
                    </div>

                    <div class="info-panel">
                        <div class="info-title"><i class="fas fa-atom"></i> Recombination Mechanisms</div>
                        <div class="info-text" id="emissionInfo">
                            Configure excitation parameters to study different recombination pathways and emission characteristics.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Module 3: Knowledge Challenges -->
        <div class="module-content" id="module-2">
            <div class="challenge-container">
                <h2 style="text-align: center; margin-bottom: 40px; color: #1f2937; font-size: 2.5rem;">
                    <i class="fas fa-trophy" style="color: #f59e0b; margin-right: 15px;"></i>
                    Photonic Device Mastery Challenges
                </h2>

                <!-- Challenge Statistics -->
                <div class="challenge-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="totalChallenges">5</div>
                        <div class="stat-label">Total Challenges</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="completedChallenges">0</div>
                        <div class="stat-label">Completed</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="challengeScore">0</div>
                        <div class="stat-label">Score</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="masteryLevel">Beginner</div>
                        <div class="stat-label">Mastery Level</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="hintsUsed">0</div>
                        <div class="stat-label">Hints Used</div>
                    </div>
                </div>

                <!-- Progress Bar -->
                <div class="challenge-progress">
                    <div class="challenge-progress-bar" id="overallProgress" style="width: 0%;"></div>
                </div>

                <!-- Generate Random Questions Button -->
                <div style="text-align: center; margin: 30px 0;">
                    <button class="challenge-btn challenge-btn-primary" onclick="generateNewQuestions()" style="padding: 15px 30px; font-size: 18px;">
                        <i class="fas fa-random"></i> Generate New Challenge Set
                    </button>
                </div>

                <!-- Challenge 1: Multiple Choice Quiz -->
                <div class="challenge-section" id="challenge1">
                    <div class="challenge-header">
                        <div class="challenge-icon">🧠</div>
                        <div>
                            <h3 class="challenge-title">Photonic Fundamentals Quiz</h3>
                            <p class="challenge-description">Test your understanding of photon-semiconductor interactions and quantum optics principles!</p>
                        </div>
                    </div>

                    <div id="mcqQuestions"></div>

                    <div class="challenge-controls">
                        <button class="challenge-btn challenge-btn-primary" onclick="checkMCQAnswers()">
                            <i class="fas fa-check"></i> Check Answers
                        </button>
                        <button class="challenge-btn challenge-btn-secondary" onclick="resetChallenge(1)">
                            <i class="fas fa-undo"></i> Reset
                        </button>
                        <button class="challenge-btn challenge-btn-secondary" onclick="showMCQHints()">
                            <i class="fas fa-lightbulb"></i> Show Hints
                        </button>
                    </div>

                    <div class="challenge-feedback" id="challenge1-feedback"></div>
                </div>

                <!-- Challenge 2: Fill in the Blanks -->
                <div class="challenge-section" id="challenge2">
                    <div class="challenge-header">
                        <div class="challenge-icon">📝</div>
                        <div>
                            <h3 class="challenge-title">Complete the Equations</h3>
                            <p class="challenge-description">Fill in the missing terms in these fundamental photonic device equations!</p>
                        </div>
                    </div>

                    <div id="fillBlankQuestions"></div>

                    <div class="challenge-controls">
                        <button class="challenge-btn challenge-btn-primary" onclick="checkFillBlanks()">
                            <i class="fas fa-check"></i> Check Answers
                        </button>
                        <button class="challenge-btn challenge-btn-secondary" onclick="resetChallenge(2)">
                            <i class="fas fa-undo"></i> Reset
                        </button>
                        <button class="challenge-btn challenge-btn-secondary" onclick="showFillBlanksHint()">
                            <i class="fas fa-question-circle"></i> Hint
                        </button>
                    </div>

                    <div class="challenge-feedback" id="challenge2-feedback"></div>
                </div>

                <!-- Challenge 3: Advanced Concepts -->
                <div class="challenge-section" id="challenge3">
                    <div class="challenge-header">
                        <div class="challenge-icon">🎯</div>
                        <div>
                            <h3 class="challenge-title">Advanced Photonic Concepts</h3>
                            <p class="challenge-description">Master the deeper physics of quantum optics and advanced device operation!</p>
                        </div>
                    </div>

                    <div id="advancedQuestions"></div>

                    <div class="challenge-controls">
                        <button class="challenge-btn challenge-btn-primary" onclick="checkAdvancedAnswers()">
                            <i class="fas fa-check"></i> Check Answers
                        </button>
                        <button class="challenge-btn challenge-btn-secondary" onclick="resetChallenge(3)">
                            <i class="fas fa-undo"></i> Reset
                        </button>
                        <button class="challenge-btn challenge-btn-secondary" onclick="showAdvancedHints()">
                            <i class="fas fa-graduation-cap"></i> Show Hints
                        </button>
                    </div>

                    <div class="challenge-feedback" id="challenge3-feedback"></div>
                </div>

                <!-- Challenge 4: Calculation Challenge -->
                <div class="challenge-section" id="challenge4">
                    <div class="challenge-header">
                        <div class="challenge-icon">🧮</div>
                        <div>
                            <h3 class="challenge-title">Photonic Device Calculations</h3>
                            <p class="challenge-description">Apply quantum mechanics and optics equations to solve real device problems!</p>
                        </div>
                    </div>

                    <div id="calculationQuestions"></div>

                    <div class="challenge-controls">
                        <button class="challenge-btn challenge-btn-primary" onclick="checkCalculations()">
                            <i class="fas fa-calculator"></i> Check Answers
                        </button>
                        <button class="challenge-btn challenge-btn-secondary" onclick="resetChallenge(4)">
                            <i class="fas fa-undo"></i> Reset
                        </button>
                        <button class="challenge-btn challenge-btn-secondary" onclick="showCalculationHint()">
                            <i class="fas fa-formula"></i> Show Formulas
                        </button>
                    </div>

                    <div class="challenge-feedback" id="challenge4-feedback"></div>
                </div>
                

            </div>
        </div>
    </div>

    <!-- Floating Action Buttons -->
    <div class="floating-button tour" onclick="startGuidedTour()">
        <i class="fas fa-route"></i>
    </div>

    <div class="floating-button primary" onclick="toggleHelp()">
        <i class="fas fa-question"></i>
    </div>

    <!-- Tour Elements -->
    <div class="tour-overlay" id="tourOverlay">
        <div class="tour-spotlight" id="tourSpotlight"></div>
        <div class="tour-spotlight-secondary" id="tourSpotlightSecondary" style="display: none;"></div>
    </div>

    <div class="tour-popup" id="tourPopup">
        <div class="tour-header">
            <div class="tour-step-number" id="tourStepNumber">Step 1/10</div>
            <div class="tour-title" id="tourTitle">Welcome to the Photonics Lab</div>
        </div>
        <div class="tour-progress">
            <div class="tour-progress-bar" id="tourProgress"></div>
        </div>
        <div class="tour-content" id="tourContent">
            Let's explore how photons interact with semiconductor materials!
        </div>
        <div id="tourChallenge"></div>
        <div class="tour-controls">
            <button class="tour-btn tour-btn-secondary" onclick="skipTour()">Skip Tour</button>
            <button class="tour-btn tour-btn-primary" onclick="nextTourStep()">Next <i class="fas fa-arrow-right"></i></button>
        </div>
    </div>

    <div class="tour-score" id="tourScore">
        <div class="tour-score-title">🏆 Your Progress</div>
        <div class="tour-score-item">
            <span id="tourScoreValue">0</span> points earned
        </div>
        <div class="tour-score-item">
            <span id="tourChallengesValue">0/3</span> challenges completed
        </div>
        <div class="tour-score-item">
            <span id="tourConceptsValue">0/10</span> concepts learned
        </div>
    </div>

    <div class="tour-achievements" id="tourAchievements">
        <div class="achievement-icon">🎉</div>
        <div class="achievement-title" id="achievementTitle">Achievement Unlocked!</div>
        <div class="achievement-description" id="achievementDescription">You've mastered a new concept!</div>
        <button class="tour-btn tour-btn-primary" onclick="closeAchievement()">Continue</button>
    </div>

    <!-- Help Panel -->
    <div class="floating-panel" id="helpPanel">
        <div class="floating-panel-header">
            <h3 class="panel-title">Photonics Lab Help</h3>
            <div class="floating-panel-close" onclick="toggleHelp()">
                <i class="fas fa-times"></i>
            </div>
        </div>
        <div class="floating-panel-content">
            <p style="margin-bottom: 15px;">This virtual lab allows you to explore photon-semiconductor interactions through interactive simulations.</p>
            
            <h4 style="margin: 15px 0 10px; color: #4f46e5;">Available Modules:</h4>
            <ul style="padding-left: 20px; margin-bottom: 15px;">
                <li><strong>Quantum Absorption</strong> - Visualize how photons are absorbed in semiconductor materials</li>
                <li><strong>Carrier Dynamics</strong> - Explore carrier recombination and emission processes</li>
                <li><strong>Knowledge Challenges</strong> - Test your understanding with interactive quizzes</li>
            </ul>
            
            <h4 style="margin: 15px 0 10px; color: #4f46e5;">Getting Started:</h4>
            <p>1. Use the tabs at the top to switch between modules</p>
            <p>2. Adjust the controls to see how different parameters affect the physics</p>
            <p>3. Click the <i class="fas fa-route"></i> button for a guided tour</p>
            <p>4. Hover over elements for additional information</p>
            
            <div style="background: #f0f9ff; padding: 10px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #0284c7;">
                <p style="font-weight: 600; color: #0c4a6e; margin-bottom: 5px;">Tip:</p>
                <p style="color: #075985; font-size: 0.9rem;">For the best learning experience, follow the guided tour first to understand all features and concepts.</p>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentModule = 0;
        let animationRunning = false;
        let continuousMode = false;
        let emissionActive = false;
        let animationId = null;
        let emissionAnimationId = null;
        
        // Challenge system globals
        let challengeStates = {
            1: { completed: false, score: 0, hintsUsed: 0 },
            2: { completed: false, score: 0, hintsUsed: 0 },
            3: { completed: false, score: 0, hintsUsed: 0 },
            4: { completed: false, score: 0, hintsUsed: 0 },
            5: { completed: false, score: 0, hintsUsed: 0 }
        };

        // Enhanced material database
        const materials = {
            si: { 
                name: "Silicon", 
                bandgap: 1.12, 
                type: "indirect", 
                color: "#6366f1",
                density: 2.33,
                mobility_e: 1400,
                mobility_h: 470,
                refractive_index: 3.5,
                thermal_conductivity: 148,
                description: "Most common semiconductor with excellent electronic properties"
            },
            gaas: { 
                name: "GaAs", 
                bandgap: 1.42, 
                type: "direct", 
                color: "#ef4444",
                density: 5.32,
                mobility_e: 8500,
                mobility_h: 400,
                refractive_index: 3.4,
                thermal_conductivity: 55,
                description: "High-performance direct bandgap semiconductor for optoelectronics"
            },
            ge: { 
                name: "Germanium", 
                bandgap: 0.67, 
                type: "indirect", 
                color: "#8b5cf6",
                density: 5.32,
                mobility_e: 3900,
                mobility_h: 1900,
                refractive_index: 4.0,
                thermal_conductivity: 60,
                description: "High mobility semiconductor for high-frequency applications"
            },
            inp: { 
                name: "InP", 
                bandgap: 1.34, 
                type: "direct", 
                color: "#06b6d4",
                density: 4.81,
                mobility_e: 4600,
                mobility_h: 150,
                refractive_index: 3.2,
                thermal_conductivity: 68,
                description: "Telecom-grade semiconductor for fiber optic applications"
            },
            ingaas: { 
                name: "InGaAs", 
                bandgap: 0.75, 
                type: "direct", 
                color: "#10b981",
                density: 5.6,
                mobility_e: 12000,
                mobility_h: 300,
                refractive_index: 3.6,
                thermal_conductivity: 45,
                description: "Ultra-high mobility for near-infrared photodetectors"
            },
            algaas: { 
                name: "AlGaAs", 
                bandgap: 1.8, 
                type: "direct", 
                color: "#f59e0b",
                density: 3.76,
                mobility_e: 2000,
                mobility_h: 180,
                refractive_index: 3.0,
                thermal_conductivity: 90,
                description: "Tunable bandgap for laser diodes and solar cells"
            }
        };

        // Challenge System Variables
        let selectedQuestions = {
            mcq: [],
            fillBlanks: [],
            advanced: [],
            calculations: [],
            matching: []
        };
        
        let challengeAnswers = {
            mcq: [],
            fillBlanks: [],
            advanced: [],
            calculations: [],
            matching: []
        };
        
        let challengeStats = {
            completed: 0,
            total: 5,
            score: 0,
            hintsUsed: 0
        };

        // Question Banks
        const mcqQuestionBank = [
            {
                question: "What happens when a photon with energy equal to the bandgap hits a semiconductor?",
                options: ["The photon is always reflected", "An electron-hole pair is generated", "The material becomes conductive", "The photon energy is stored"],
                correct: 1,
                explanation: "When a photon with energy equal to or greater than the bandgap hits a semiconductor, it can excite an electron from the valence band to the conduction band, creating an electron-hole pair.",
                hint: "Think about energy conservation and band structure in semiconductors.",
                difficulty: "basic",
                topic: "absorption"
            },
            {
                question: "In direct bandgap semiconductors, what makes them more efficient for light emission?",
                options: ["Higher doping levels", "Direct transitions without phonon assistance", "Lower operating temperatures", "Smaller crystal size"],
                correct: 1,
                explanation: "Direct bandgap semiconductors allow direct radiative recombination without requiring phonon assistance, making them highly efficient for LEDs and laser applications.",
                hint: "Consider the momentum conservation requirements in band-to-band transitions.",
                difficulty: "intermediate",
                topic: "emission"
            },
            {
                question: "Why do indirect bandgap semiconductors like Silicon emit light poorly?",
                options: ["They have too many defects", "Radiative recombination requires phonon assistance", "They operate at wrong temperatures", "Their bandgap is too large"],
                correct: 1,
                explanation: "In indirect bandgap semiconductors, radiative recombination requires both photon and phonon conservation, making the process much less efficient compared to direct bandgap materials.",
                hint: "Think about the band structure and momentum conservation during transitions.",
                difficulty: "intermediate",
                topic: "emission"
            },
            {
                question: "What determines the wavelength of light emitted from a semiconductor?",
                options: ["Doping concentration", "Crystal size", "Bandgap energy", "Operating current"],
                correct: 2,
                explanation: "The wavelength of emitted light is determined by the bandgap energy through the relation λ = hc/Eg, where larger bandgaps produce shorter wavelengths.",
                hint: "Remember the equation relating photon energy and wavelength: E = hc/λ.",
                difficulty: "basic",
                topic: "emission"
            },
            {
                question: "In a photodiode, what creates the photocurrent?",
                options: ["Thermal generation", "Impact ionization", "Photogenerated carriers", "Tunneling effect"],
                correct: 2,
                explanation: "Photocurrent in photodiodes is created when incident photons generate electron-hole pairs, which are then separated by the built-in electric field."
            },
            {
                question: "What is the quantum efficiency of a photodetector?",
                options: ["Ratio of output photons to input photons", "Ratio of generated carriers to incident photons", "Ratio of current to voltage", "Ratio of power output to input"],
                correct: 1,
                explanation: "Quantum efficiency is the ratio of photogenerated electron-hole pairs to the number of incident photons, indicating how effectively light is converted to electrical carriers."
            },
            {
                question: "Why are III-V semiconductors preferred for photonic applications?",
                options: ["Lower cost", "Direct bandgaps and high mobility", "Better thermal stability", "Easier processing"],
                correct: 1,
                explanation: "III-V semiconductors like GaAs and InP have direct bandgaps making them efficient for light emission and detection, plus high carrier mobility for fast response."
            },
            {
                question: "What is the main difference between fluorescence and phosphorescence?",
                options: ["Color of emission", "Lifetime of excited states", "Required excitation power", "Temperature dependence"],
                correct: 1,
                explanation: "Fluorescence involves fast direct radiative recombination (ns-μs), while phosphorescence involves slow recombination through metastable trap states (ms-s)."
            }
        ];

        const fillBlankQuestionBank = [
            {
                text: "When a photon with energy _____ than the bandgap hits a semiconductor, it can create an _____ pair.",
                blanks: ["greater", "electron-hole"],
                explanation: "Photons must have energy equal to or greater than the bandgap to excite electrons across the energy gap."
            },
            {
                text: "In _____ bandgap semiconductors, radiative recombination occurs without _____ assistance.",
                blanks: ["direct", "phonon"],
                explanation: "Direct bandgap materials allow direct radiative transitions, making them efficient light emitters."
            },
            {
                text: "The wavelength of emitted light is related to bandgap by λ = _____/_____ where h is Planck's constant.",
                blanks: ["hc", "Eg"],
                explanation: "The fundamental relationship between photon energy and wavelength determines emission wavelength."
            },
            {
                text: "The _____ efficiency of a photodetector is the ratio of generated _____ to incident photons.",
                blanks: ["quantum", "carriers"],
                explanation: "Quantum efficiency measures how effectively photons are converted to electrical carriers."
            },
            {
                text: "In _____ semiconductors like Silicon, light emission is _____ due to indirect transitions.",
                blanks: ["indirect", "inefficient"],
                explanation: "Indirect bandgap materials require phonon assistance, making radiative recombination less probable."
            }
        ];

        const advancedQuestionBank = [
            {
                question: "In quantum well structures, how does carrier confinement affect the density of states?",
                options: [
                    "It decreases the density of states",
                    "It creates discrete energy levels and step-like density",
                    "It has no effect on density of states",
                    "It only affects holes, not electrons"
                ],
                correct: 1,
                explanation: "Quantum confinement creates discrete energy levels in the confined direction and results in a step-like density of states, increasing the optical gain."
            },
            {
                question: "What causes the temperature dependence of semiconductor bandgaps?",
                options: [
                    "Thermal expansion only",
                    "Lattice vibrations (phonons) and thermal expansion",
                    "Doping concentration changes",
                    "Carrier density variations"
                ],
                correct: 1,
                explanation: "Bandgap temperature dependence is primarily due to lattice thermal expansion and electron-phonon interactions, typically following the Varshni equation."
            },
            {
                question: "In avalanche photodiodes, what determines the multiplication noise?",
                options: [
                    "Dark current level",
                    "Different impact ionization rates for electrons and holes",
                    "Temperature coefficient",
                    "Bias voltage stability"
                ],
                correct: 1,
                explanation: "The ratio of electron to hole impact ionization coefficients (k = β/α) determines the excess noise factor in APDs."
            },
            {
                question: "What is the significance of the Urbach tail in semiconductor absorption?",
                options: [
                    "It determines the bandgap value",
                    "It represents disorder-induced states below the bandgap",
                    "It shows free carrier absorption",
                    "It indicates crystal quality"
                ],
                correct: 1,
                explanation: "The Urbach tail represents exponential absorption below the bandgap due to disorder, defects, and thermal broadening of band edges."
            }
        ];

        const calculationQuestionBank = [
            {
                question: "Calculate the wavelength of light emitted by a GaAs device with bandgap Eg = 1.42 eV.",
                formula: "λ = hc/Eg = (1.24 eV·μm)/Eg",
                answer: "0.873",
                unit: "μm",
                explanation: "Using λ = hc/Eg = 1.24 eV·μm / 1.42 eV = 0.873 μm = 873 nm"
            },
            {
                question: "If a photodiode has quantum efficiency η = 80% at λ = 1.55 μm, calculate its responsivity R.",
                formula: "R = (η × q × λ)/(h × c) = (η × λ)/1.24",
                answer: "1.0",
                unit: "A/W",
                explanation: "R = (0.8 × 1.55 μm)/1.24 eV·μm = 1.0 A/W"
            },
            {
                question: "Calculate the photon energy for light with wavelength λ = 650 nm (red light).",
                formula: "E = hc/λ = 1240 eV·nm / λ",
                answer: "1.91",
                unit: "eV",
                explanation: "E = 1240 eV·nm / 650 nm = 1.91 eV"
            },
            {
                question: "A PIN photodiode generates 100 μA photocurrent with 1 mW incident power at 850 nm. Calculate its quantum efficiency.",
                formula: "η = (R × hc)/(q × λ), where R = I/P",
                answer: "73",
                unit: "%",
                explanation: "R = 100 μA / 1 mW = 0.1 A/W, η = (0.1 × 1.24)/(1.46) = 0.73 = 73%"
            }
        ];
        
        // Matching questions bank
        const matchingQuestionBank = [
            {
                title: "Match Semiconductor Materials with Their Properties",
                left: [
                    { id: "m1", text: "Silicon (Si)" },
                    { id: "m2", text: "Gallium Arsenide (GaAs)" },
                    { id: "m3", text: "Germanium (Ge)" },
                    { id: "m4", text: "Indium Phosphide (InP)" }
                ],
                right: [
                    { id: "p1", text: "Indirect bandgap, 1.12 eV" },
                    { id: "p2", text: "Direct bandgap, 1.42 eV" },
                    { id: "p3", text: "Indirect bandgap, 0.67 eV" },
                    { id: "p4", text: "Direct bandgap, 1.35 eV" }
                ],
                pairs: [
                    { left: "m1", right: "p1" },
                    { left: "m2", right: "p2" },
                    { left: "m3", right: "p3" },
                    { left: "m4", right: "p4" }
                ],
                explanation: "Matching semiconductor materials to their bandgap properties helps understand their optical applications.",
                difficulty: "intermediate",
                topic: "materials"
            },
            {
                title: "Match Photonic Processes with Their Descriptions",
                left: [
                    { id: "p1", text: "Absorption" },
                    { id: "p2", text: "Fluorescence" },
                    { id: "p3", text: "Phosphorescence" },
                    { id: "p4", text: "Electroluminescence" }
                ],
                right: [
                    { id: "d1", text: "Photon creates electron-hole pair" },
                    { id: "d2", text: "Fast radiative recombination (ns-μs)" },
                    { id: "d3", text: "Slow emission via trap states (ms-s)" },
                    { id: "d4", text: "Light emission from current flow" }
                ],
                pairs: [
                    { left: "p1", right: "d1" },
                    { left: "p2", right: "d2" },
                    { left: "p3", right: "d3" },
                    { left: "p4", right: "d4" }
                ],
                explanation: "Understanding these different processes helps explain how photons interact with matter in different devices.",
                difficulty: "basic",
                topic: "processes"
            },
            {
                title: "Match Photonic Devices with Applications",
                left: [
                    { id: "d1", text: "LED" },
                    { id: "d2", text: "Photodiode" },
                    { id: "d3", text: "Laser Diode" },
                    { id: "d4", text: "Quantum Dot Display" }
                ],
                right: [
                    { id: "a1", text: "General lighting and indicators" },
                    { id: "a2", text: "Optical communication receivers" },
                    { id: "a3", text: "High-speed data transmission" },
                    { id: "a4", text: "High color gamut television screens" }
                ],
                pairs: [
                    { left: "d1", right: "a1" },
                    { left: "d2", right: "a2" },
                    { left: "d3", right: "a3" },
                    { left: "d4", right: "a4" }
                ],
                explanation: "Different photonic devices are optimized for specific applications based on their emission or detection properties.",
                difficulty: "basic",
                topic: "devices"
            }
        ];

        // Module switching function
        function switchModule(moduleIndex) {
            stopAllAnimations();
            
            // Hide all modules
            document.querySelectorAll('.module-content').forEach((module, index) => {
                if (module.classList.contains('active')) {
                    module.style.opacity = '0';
                    setTimeout(() => {
                        module.classList.remove('active');
                    }, 200);
                }
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab-btn').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected module
            setTimeout(() => {
                const targetModule = document.getElementById(`module-${moduleIndex}`);
                targetModule.classList.add('active');
                targetModule.style.opacity = '1';
                
                document.querySelectorAll('.tab-btn')[moduleIndex].classList.add('active');
                currentModule = moduleIndex;
                
                // Initialize module-specific functionality
                if (moduleIndex === 0) {
                    initAbsorptionModule();
                } else if (moduleIndex === 1) {
                    initEmissionModule();
                }
            }, 250);
        }

        function stopAllAnimations() {
            animationRunning = false;
            continuousMode = false;
            emissionActive = false;
            
            if (animationId) {
                clearTimeout(animationId);
                animationId = null;
            }
            if (emissionAnimationId) {
                clearTimeout(emissionAnimationId);
                emissionAnimationId = null;
            }
        }

        // Module 1: Absorption Functions
        function initAbsorptionModule() {
            updateAbsorption();
            drawAbsorptionGraph();
        }

        function updateAbsorption() {
            const material = document.getElementById('material').value;
            const mat = materials[material];
            const photonEnergy = parseFloat(document.getElementById('photonEnergy').value);
            const temperature = parseFloat(document.getElementById('temperature').value);
            const quality = parseFloat(document.getElementById('crystalQuality').value);
            
            updateBandDiagram(mat, temperature, quality);
            
            const thermalEnergy = 0.0259 * (temperature / 300);
            const bandgapShift = calculateBandgapShift(mat, temperature);
            const effectiveBandgap = mat.bandgap + bandgapShift;
            
            const canAbsorb = photonEnergy >= effectiveBandgap;
            const excessEnergy = Math.max(0, photonEnergy - effectiveBandgap);
            
            let absorptionCoeff = calculateAbsorptionCoefficient(mat, photonEnergy, temperature, quality);
            let quantumEff = calculateQuantumEfficiency(mat, photonEnergy, temperature, quality);
            
            const absorptionStatus = canAbsorb ? 
                `<span style="color: #059669;">✓ Strong absorption (α = ${absorptionCoeff.toExponential(2)} cm⁻¹)</span>` : 
                `<span style="color: #dc2626;">✗ Transparent (E < Eg)</span>`;
            
            document.getElementById('absorptionInfo').innerHTML = `
                <strong>${mat.name} Analysis:</strong><br>
                <strong>Bandgap:</strong> ${effectiveBandgap.toFixed(3)} eV (${(1240/effectiveBandgap).toFixed(0)} nm)<br>
                <strong>Type:</strong> ${mat.type} bandgap semiconductor<br>
                <strong>Refractive Index:</strong> ${mat.refractive_index}<br>
                <strong>Crystal Quality:</strong> ${getQualityDescription(quality)}<br>
                <hr style="margin: 8px 0; border: 1px solid #e5e7eb;">
                <strong>Photon:</strong> ${photonEnergy} eV (${(1240/photonEnergy).toFixed(0)} nm)<br>
                <strong>Excess Energy:</strong> ${excessEnergy.toFixed(3)} eV<br>
                <strong>Quantum Efficiency:</strong> ${(quantumEff*100).toFixed(1)}%<br>
                ${absorptionStatus}
            `;
            
            drawAbsorptionGraph();
        }

        function calculateBandgapShift(material, temperature) {
            const alpha = material.type === 'direct' ? 5.405e-4 : 4.73e-4;
            const beta = material.type === 'direct' ? 204 : 636;
            return -alpha * temperature * temperature / (temperature + beta);
        }

        function calculateAbsorptionCoefficient(material, energy, temperature, quality) {
            const effectiveBandgap = material.bandgap + calculateBandgapShift(material, temperature);
            
            if (energy <= effectiveBandgap) return 1e-3;
            
            const excessEnergy = energy - effectiveBandgap;
            let alpha;
            
            if (material.type === 'direct') {
                alpha = Math.pow(excessEnergy, 0.5) * 3e5 * Math.sqrt(temperature / 300);
                if (excessEnergy < 0.05) {
                    alpha += Math.exp(-excessEnergy * 50) * 2e4 * (quality / 10);
                }
            } else {
                alpha = Math.pow(excessEnergy, 2) * 8e4 * (temperature / 300);
                alpha *= 0.1;
            }
            
            alpha *= (quality / 10);
            
            if (energy > effectiveBandgap + 1.0) {
                alpha += Math.pow(energy - effectiveBandgap - 1.0, 1.5) * 2e5;
            }
            
            return Math.max(alpha, 1e-2);
        }

        function calculateQuantumEfficiency(material, energy, temperature, quality) {
            const effectiveBandgap = material.bandgap + calculateBandgapShift(material, temperature);
            
            if (energy < effectiveBandgap) return 0;
            
            let baseEff = material.type === 'direct' ? 0.85 : 0.15;
            
            const excessRatio = (energy - effectiveBandgap) / effectiveBandgap;
            if (excessRatio > 0.5) {
                baseEff *= Math.exp(-excessRatio);
            }
            
            baseEff *= Math.exp(-(temperature - 300) / 500);
            baseEff *= Math.pow(quality / 10, 0.3);
            
            return Math.min(baseEff, 0.95);
        }

        function getQualityDescription(quality) {
            if (quality > 8) return "High (Low defects)";
            if (quality > 5) return "Medium (Some defects)";
            return "Low (High defects)";
        }

        function updateBandDiagram(material, temperature, quality) {
            const conductionBand = document.getElementById('conductionBand');
            const valenceBand = document.getElementById('valenceBand');
            const bandDiagram = document.getElementById('bandDiagram');
            
            // Clear existing elements except legends
            bandDiagram.querySelectorAll('.band-gap-label, .energy-axis').forEach(el => el.remove());
            
            const totalHeight = 280;
            const bandgapShift = calculateBandgapShift(material, temperature);
            const effectiveBandgap = material.bandgap + bandgapShift;
            const centerGap = effectiveBandgap * 40;
            const maxGap = 100;
            const actualGap = Math.min(centerGap, maxGap);
            
            const centerY = totalHeight / 2;
            const conductionTop = centerY - actualGap/2 - 20;
            const valenceBTop = centerY + actualGap/2;
            
            conductionBand.style.top = `${(conductionTop/totalHeight) * 100}%`;
            valenceBand.style.top = `${(valenceBTop/totalHeight) * 100}%`;
            
            // Enhanced material-specific styling
            if (material.type === 'direct') {
                conductionBand.style.background = `linear-gradient(90deg, ${material.color}88, ${material.color}, ${material.color}88)`;
                conductionBand.style.boxShadow = `0 6px 20px ${material.color}40, inset 0 2px 4px rgba(255, 255, 255, 0.2)`;
            } else {
                conductionBand.style.background = `linear-gradient(90deg, #581c87, ${material.color}, #581c87)`;
            }
            
            // Temperature effects
            const tempFactor = Math.min(1.3, temperature / 300);
            valenceBand.style.filter = `brightness(${tempFactor})`;
            
            // Quality effects
            const opacity = 0.8 + (quality / 10) * 0.2;
            conductionBand.style.opacity = opacity;
            valenceBand.style.opacity = opacity;
            
            // Enhanced bandgap label
            const gapLabel = document.createElement('div');
            gapLabel.className = 'band-gap-label';
            gapLabel.textContent = `Eg = ${effectiveBandgap.toFixed(3)} eV`;
            gapLabel.style.top = `${centerY/totalHeight * 100}%`;
            gapLabel.style.transform = 'translateX(-50%) translateY(-50%)';
            bandDiagram.appendChild(gapLabel);
            
            // Energy axis
            const energyAxis = document.createElement('div');
            energyAxis.className = 'energy-axis';
            bandDiagram.appendChild(energyAxis);
            
            // Add or update absorption legend
            addAbsorptionLegend(bandDiagram);
        }

        function addAbsorptionLegend(container) {
            // Remove existing legend
            const existingLegend = container.querySelector('.simulation-legend');
            if (existingLegend) {
                existingLegend.remove();
            }
            
            // Add legend toggle button
            let toggleButton = container.querySelector('.legend-toggle');
            if (!toggleButton) {
                toggleButton = document.createElement('button');
                toggleButton.className = 'legend-toggle';
                toggleButton.innerHTML = '?';
                toggleButton.title = 'Toggle Physics Legend';
                toggleButton.onclick = () => toggleAbsorptionLegend();
                container.appendChild(toggleButton);
            }
            
            // Create compact legend
            const legend = document.createElement('div');
            legend.className = 'simulation-legend';
            legend.id = 'absorption-legend';
            legend.innerHTML = `
                <div class="legend-header">
                    <div class="legend-title">Quantum Absorption</div>
                    <button class="legend-collapse-btn" onclick="collapseLegend('absorption-legend')" title="Collapse">−</button>
                </div>
                <div class="legend-content">
                    <div class="legend-section">
                        <div class="legend-section-title">Elements</div>
                        <div class="legend-item">
                            <div class="legend-symbol photon">hν</div>
                            <div class="legend-text">Photon (E=hν)</div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-symbol electron">e⁻</div>
                            <div class="legend-text">Photoelectron</div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-symbol hole">h⁺</div>
                            <div class="legend-text">Hole (+charge)</div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-symbol absorption">!</div>
                            <div class="legend-text">Absorption Event</div>
                        </div>
                    </div>
                    <div class="legend-section">
                        <div class="legend-section-title">Energy Bands</div>
                        <div class="legend-item">
                            <div class="legend-symbol band"></div>
                            <div class="legend-text">Conduction Band</div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-symbol band" style="background: linear-gradient(45deg, #ef4444, #dc2626);"></div>
                            <div class="legend-text">Valence Band</div>
                        </div>
                    </div>
                </div>
            `;
            
            container.appendChild(legend);
            
            // Add quick info panel
            const quickInfo = document.createElement('div');
            quickInfo.className = 'quick-info';
            quickInfo.id = 'absorption-quick-info';
            quickInfo.innerHTML = `
                <div class="quick-info-title">Energy Conservation</div>
                E_photon = E_gap + E_kinetic
            `;
            container.appendChild(quickInfo);
        }

        function addEmissionLegend() {
            const timeline = document.getElementById('emissionTimeline');
            
            // Remove existing legend
            const existingLegend = timeline.querySelector('.simulation-legend');
            if (existingLegend) {
                existingLegend.remove();
            }
            
            // Add legend toggle button
            let toggleButton = timeline.querySelector('.legend-toggle');
            if (!toggleButton) {
                toggleButton = document.createElement('button');
                toggleButton.className = 'legend-toggle';
                toggleButton.innerHTML = '?';
                toggleButton.title = 'Toggle Emission Physics Legend';
                toggleButton.onclick = () => toggleEmissionLegend();
                timeline.appendChild(toggleButton);
            }
            
            const type = document.getElementById('emissionType').value;
            
            // Create compact emission legend
            const legend = document.createElement('div');
            legend.className = 'simulation-legend';
            legend.id = 'emission-legend';
            legend.innerHTML = `
                <div class="legend-header">
                    <div class="legend-title">Carrier Dynamics</div>
                    <button class="legend-collapse-btn" onclick="collapseLegend('emission-legend')" title="Collapse">−</button>
                </div>
                <div class="legend-content">
                    <div class="legend-section">
                        <div class="legend-section-title">Carriers</div>
                        <div class="legend-item">
                            <div class="legend-symbol electron">e*</div>
                            <div class="legend-text">Excited Carrier</div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-symbol emission">hν</div>
                            <div class="legend-text">Emitted Photon</div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-symbol trap">T</div>
                            <div class="legend-text">Trap States</div>
                        </div>
                    </div>
                    <div class="legend-section">
                        <div class="legend-section-title">Levels</div>
                        <div class="legend-item">
                            <div class="legend-symbol band"></div>
                            <div class="legend-text">Conduction Band</div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-symbol band" style="background: linear-gradient(45deg, #ef4444, #dc2626);"></div>
                            <div class="legend-text">Valence Band</div>
                        </div>
                    </div>
                </div>
            `;
            
            timeline.appendChild(legend);
            
            // Add mechanism-specific quick info
            const quickInfo = document.createElement('div');
            quickInfo.className = 'quick-info';
            quickInfo.id = 'emission-quick-info';
            quickInfo.innerHTML = `
                <div class="quick-info-title">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
                ${getQuickEmissionInfo(type)}
            `;
            timeline.appendChild(quickInfo);
        }

        function getQuickEmissionInfo(type) {
            switch(type) {
                case 'fluorescence':
                    return 'I(t) = I₀×exp(-t/τ)<br>Fast S₁→S₀ (ns-μs)';
                case 'phosphorescence':
                    return 'I(t) = I₀×exp(-(t/τ)^β)<br>Slow T₁→S₀ (ms-s)';
                case 'led':
                    return 'I = η×(I/q)×hν<br>Band-to-band';
                case 'quantum_dots':
                    return 'E = E_bulk + ℏ²π²/(2m*R²)<br>Size-tunable';
                default:
                    return 'Carrier recombination';
            }
        }

        function toggleAbsorptionLegend() {
            const legend = document.getElementById('absorption-legend');
            const quickInfo = document.getElementById('absorption-quick-info');
            const button = document.querySelector('#bandDiagram .legend-toggle');
            
            if (legend) {
                legend.classList.toggle('visible');
                if (quickInfo) quickInfo.classList.toggle('visible');
                button.classList.toggle('active');
            }
        }

        function toggleEmissionLegend() {
            const legend = document.getElementById('emission-legend');
            const quickInfo = document.getElementById('emission-quick-info');
            const button = document.querySelector('#emissionTimeline .legend-toggle');
            
            if (legend) {
                legend.classList.toggle('visible');
                if (quickInfo) quickInfo.classList.toggle('visible');
                button.classList.toggle('active');
            }
        }

        function collapseLegend(legendId) {
            const legend = document.getElementById(legendId);
            const collapseBtn = legend.querySelector('.legend-collapse-btn');
            const content = legend.querySelector('.legend-content');
            
            if (legend.classList.contains('collapsed')) {
                legend.classList.remove('collapsed');
                content.style.display = 'block';
                collapseBtn.innerHTML = '−';
                collapseBtn.title = 'Collapse';
            } else {
                legend.classList.add('collapsed');
                content.style.display = 'none';
                collapseBtn.innerHTML = '+';
                collapseBtn.title = 'Expand';
            }
        }

        function updateTemperature() {
            const temp = document.getElementById('temperature').value;
            document.getElementById('tempValue').textContent = temp;
            updateAbsorption();
        }

        function updatePhotonEnergy() {
            const energy = document.getElementById('photonEnergy').value;
            document.getElementById('energyValue').textContent = energy;
            updateAbsorption();
        }

        function updateQuality() {
            const quality = document.getElementById('crystalQuality').value;
            document.getElementById('qualityValue').textContent = getQualityDescription(quality);
            updateAbsorption();
        }

        function drawAbsorptionGraph() {
            try {
                const material = document.getElementById('material').value;
                const mat = materials[material];
                const temperature = parseFloat(document.getElementById('temperature').value);
                const quality = parseFloat(document.getElementById('crystalQuality').value);
                const currentEnergy = parseFloat(document.getElementById('photonEnergy').value);
                
                const energyRange = [];
                const absorptionCoeff = [];
                const transmittance = [];
                
                for (let energy = 0.3; energy <= 4.5; energy += 0.02) {
                    energyRange.push(energy);
                    
                    const alpha = calculateAbsorptionCoefficient(mat, energy, temperature, quality);
                    absorptionCoeff.push(alpha);
                    
                    const thickness = 1e-4; // 1 μm in cm
                    const n = mat.refractive_index;
                    const R = Math.pow((n - 1) / (n + 1), 2);
                    const T = (1 - R) * Math.exp(-alpha * thickness) * 100;
                    transmittance.push(T);
                }
                
                const absorptionTrace = {
                    x: energyRange,
                    y: absorptionCoeff,
                    type: 'scatter',
                    mode: 'lines',
                    line: {
                        color: mat.color,
                        width: 3
                    },
                    name: `${mat.name} Absorption Coefficient`,
                    yaxis: 'y1',
                    hovertemplate: `<b>Absorption</b><br>` +
                                  `Energy: %{x:.2f} eV<br>` +
                                  `α: %{y:.2e} cm⁻¹<br>` +
                                  `<extra></extra>`
                };
                
                const transmittanceTrace = {
                    x: energyRange,
                    y: transmittance,
                    type: 'scatter',
                    mode: 'lines',
                    line: {
                        color: mat.color,
                        width: 2,
                        dash: 'dot'
                    },
                    name: `Transmittance (1μm)`,
                    yaxis: 'y2',
                    opacity: 0.7,
                    hovertemplate: `<b>Transmittance</b><br>` +
                                  `Energy: %{x:.2f} eV<br>` +
                                  `T: %{y:.1f}%<br>` +
                                  `<extra></extra>`
                };
                
                const effectiveBandgap = mat.bandgap + calculateBandgapShift(mat, temperature);
                const maxY = Math.max(...absorptionCoeff);
                const bandgapLine = {
                    x: [effectiveBandgap, effectiveBandgap],
                    y: [1e-2, maxY],
                    type: 'scatter',
                    mode: 'lines',
                    line: {
                        color: '#ef4444',
                        width: 3,
                        dash: 'dash'
                    },
                    name: `Bandgap Energy`,
                    yaxis: 'y1'
                };
                
                const currentEnergyMarker = {
                    x: [currentEnergy, currentEnergy],
                    y: [1e-2, maxY],
                    type: 'scatter',
                    mode: 'lines',
                    line: {
                        color: '#fbbf24',
                        width: 3,
                        dash: 'dashdot'
                    },
                    name: `Current Photon`,
                    yaxis: 'y1'
                };
                
                const layout = {
                    title: {
                        text: `${mat.name} Optical Properties (T=${temperature}K)`,
                        font: { family: 'Poppins', size: 16 }
                    },
                    xaxis: {
                        title: 'Photon Energy (eV)',
                        range: [0.3, 4.5],
                        gridcolor: '#e5e7eb'
                    },
                    yaxis: {
                        title: 'Absorption Coefficient (cm⁻¹)',
                        type: 'log',
                        gridcolor: '#e5e7eb',
                        side: 'left'
                    },
                    yaxis2: {
                        title: 'Transmittance (%)',
                        overlaying: 'y',
                        side: 'right',
                        range: [0, 100],
                        gridcolor: 'rgba(229, 231, 235, 0.3)'
                    },
                    plot_bgcolor: '#f8fafc',
                    paper_bgcolor: 'white',
                    font: { family: 'Poppins', size: 11 },
                    margin: { t: 40, r: 60, b: 50, l: 70 },
                    height: 300,
                    showlegend: true,
                    legend: {
                        x: 0.01,
                        y: 0.99,
                        bgcolor: 'rgba(255,255,255,0.95)',
                        bordercolor: '#d1d5db',
                        borderwidth: 1,
                        font: { size: 10 }
                    }
                };
                
                const config = { responsive: true, displayModeBar: false };
                const traces = [absorptionTrace, transmittanceTrace, bandgapLine, currentEnergyMarker];
                Plotly.newPlot('absorptionPlot', traces, layout, config);
                
            } catch (error) {
                console.error('Error drawing absorption graph:', error);
            }
        }

        function animateAbsorption() {
            if (animationRunning && !continuousMode) return;
            
            const bandDiagram = document.getElementById('bandDiagram');
            const material = document.getElementById('material').value;
            const mat = materials[material];
            const photonEnergy = parseFloat(document.getElementById('photonEnergy').value);
            const temperature = parseFloat(document.getElementById('temperature').value);
            
            const effectiveBandgap = mat.bandgap + calculateBandgapShift(mat, temperature);
            
            // Clear existing animations
            bandDiagram.querySelectorAll('.photon, .electron, .hole, .absorption-event').forEach(el => el.remove());
            
            if (photonEnergy < effectiveBandgap) {
                // Photon passes through without absorption
                const photon = document.createElement('div');
                photon.className = 'photon';
                photon.style.top = '45%';
                photon.style.zIndex = '10';
                bandDiagram.appendChild(photon);
                
                animationRunning = true;
                
                setTimeout(() => {
                    if (photon.parentNode) photon.remove();
                    animationRunning = false;
                    
                    if (continuousMode) {
                        setTimeout(() => animateAbsorption(), 500);
                    }
                }, 3000);
                return;
            }
            
            // Create absorption sequence
            const photon = document.createElement('div');
            photon.className = 'photon';
            photon.style.top = '45%';
            photon.style.zIndex = '10';
            bandDiagram.appendChild(photon);
            
            animationRunning = true;
            
            // Absorption event at center
            setTimeout(() => {
                const absorptionEvent = document.createElement('div');
                absorptionEvent.className = 'absorption-event';
                absorptionEvent.style.left = '50%';
                absorptionEvent.style.top = '45%';
                absorptionEvent.style.transform = 'translate(-50%, -50%)';
                absorptionEvent.style.zIndex = '20';
                bandDiagram.appendChild(absorptionEvent);
                
                photon.remove();
                
                const numPairs = Math.min(3, Math.floor((photonEnergy - effectiveBandgap) / 1.0) + 1);
                
                setTimeout(() => {
                    for (let i = 0; i < numPairs; i++) {
                        // Create electron
                        const electron = document.createElement('div');
                        electron.className = 'electron';
                        electron.style.left = `${40 + i * 8}%`;
                        electron.style.top = '50%';
                        electron.style.zIndex = '15';
                        bandDiagram.appendChild(electron);
                        
                        // Create hole
                        const hole = document.createElement('div');
                        hole.className = 'hole';
                        hole.style.left = `${60 - i * 8}%`;
                        hole.style.top = '50%';
                        hole.style.zIndex = '15';
                        bandDiagram.appendChild(hole);
                        
                        // Move to respective bands
                        setTimeout(() => {
                            const conductionBand = document.getElementById('conductionBand');
                            const valenceBand = document.getElementById('valenceBand');
                            const cbTop = conductionBand.offsetTop;
                            const vbTop = valenceBand.offsetTop;
                            
                            electron.style.top = `${(cbTop / bandDiagram.offsetHeight) * 100 + 3}%`;
                            hole.style.top = `${(vbTop / bandDiagram.offsetHeight) * 100 + 3}%`;
                        }, 150 + i * 50);
                        
                        // Cleanup
                        setTimeout(() => {
                            if (electron.parentNode) electron.remove();
                            if (hole.parentNode) hole.remove();
                        }, 4500 + i * 200);
                    }
                    
                    absorptionEvent.remove();
                    animationRunning = false;
                    
                    if (continuousMode) {
                        setTimeout(() => animateAbsorption(), 1200);
                    }
                }, 400);
            }, 1400);
        }

        function startContinuousAnimation() {
            continuousMode = !continuousMode;
            const button = event.target;
            
            if (continuousMode) {
                button.innerHTML = '<i class="fas fa-stop"></i> Stop Continuous';
                button.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                animateAbsorption();
            } else {
                button.innerHTML = '<i class="fas fa-sync"></i> Continuous Mode';
                button.style.background = 'linear-gradient(135deg, #e879f9, #c084fc)';
                stopAllAnimations();
            }
        }

        function resetAbsorption() {
            stopAllAnimations();
            const bandDiagram = document.getElementById('bandDiagram');
            if (bandDiagram) {
                bandDiagram.querySelectorAll('.photon, .electron, .hole, .absorption-event').forEach(el => el.remove());
            }
            
            // Reset continuous mode button
            const contButton = document.querySelector('.btn-secondary');
            if (contButton) {
                contButton.innerHTML = '<i class="fas fa-sync"></i> Continuous Mode';
                contButton.style.background = 'linear-gradient(135deg, #e879f9, #c084fc)';
            }
            
            updateAbsorption();
        }

        function applyAbsorptionPreset(materialType) {
            const presets = {
                'si': { material: 'si', energy: 1.8, temp: 300, quality: 8 },
                'gaas': { material: 'gaas', energy: 1.6, temp: 300, quality: 9 },
                'ge': { material: 'ge', energy: 1.2, temp: 300, quality: 7 },
                'inp': { material: 'inp', energy: 1.5, temp: 300, quality: 8 },
                'ingaas': { material: 'ingaas', energy: 1.0, temp: 300, quality: 9 },
                'algaas': { material: 'algaas', energy: 2.0, temp: 300, quality: 8 }
            };
            
            const preset = presets[materialType];
            if (!preset) return;
            
            document.getElementById('material').value = preset.material;
            document.getElementById('photonEnergy').value = preset.energy;
            document.getElementById('temperature').value = preset.temp;
            document.getElementById('crystalQuality').value = preset.quality;
            
            updateAbsorption();
        }

        // Module 2: Enhanced Emission Functions
        function initEmissionModule() {
            updateEmission();
            
            // Show emission legend after initialization
            setTimeout(() => {
                const emissionLegend = document.getElementById('emission-legend');
                const emissionQuickInfo = document.getElementById('emission-quick-info');
                if (emissionLegend) {
                    emissionLegend.classList.add('visible');
                    if (emissionQuickInfo) emissionQuickInfo.classList.add('visible');
                    const toggleBtn = document.querySelector('#emissionTimeline .legend-toggle');
                    if (toggleBtn) toggleBtn.classList.add('active');
                }
            }, 500);
        }

        function updateEmission() {
            const type = document.getElementById('emissionType').value;
            const lifetime = parseFloat(document.getElementById('carrierLifetime').value);
            const temperature = parseFloat(document.getElementById('emissionTemperature').value);
            const power = parseFloat(document.getElementById('excitationPower').value);
            
            let wavelength, quantumEff, description, indicatorClass, radiativeRate, nonRadiativeRate;
            
            switch(type) {
                case 'fluorescence':
                    wavelength = 520;
                    quantumEff = Math.max(0.1, 0.9 * Math.exp(-(temperature - 300) / 200));
                    radiativeRate = 1 / (lifetime * 1e-6); // Convert to s⁻¹
                    nonRadiativeRate = radiativeRate * (1 - quantumEff) / quantumEff;
                    description = "Fast radiative recombination via direct S₁→S₀ transitions. Spin-allowed process with ns-μs lifetimes.";
                    indicatorClass = 'fluorescence-indicator';
                    break;
                case 'phosphorescence':
                    wavelength = 580;
                    quantumEff = Math.max(0.05, 0.6 * Math.exp(-(temperature - 300) / 150));
                    radiativeRate = 1 / (lifetime * 1e-6 * 5); // Slower due to spin-forbidden
                    nonRadiativeRate = radiativeRate * (1 - quantumEff) / quantumEff;
                    description = "Slow radiative recombination via spin-forbidden T₁→S₀ transitions through metastable triplet states.";
                    indicatorClass = 'phosphorescence-indicator';
                    break;
                case 'led':
                    wavelength = 650;
                    quantumEff = Math.max(0.2, 0.85 * Math.exp(-(temperature - 300) / 300));
                    radiativeRate = 1 / (lifetime * 1e-6);
                    nonRadiativeRate = radiativeRate * (1 - quantumEff) / quantumEff;
                    description = "Efficient electroluminescence through current injection in p-n junctions. Band-to-band recombination.";
                    indicatorClass = 'led-indicator';
                    break;
                case 'quantum_dots':
                    wavelength = 480 + (temperature - 300) * 0.2; // Size-tunable emission
                    quantumEff = Math.max(0.3, 0.95 * Math.exp(-(temperature - 300) / 400));
                    radiativeRate = 1 / (lifetime * 1e-6);
                    nonRadiativeRate = radiativeRate * (1 - quantumEff) / quantumEff * 0.5; // Better surface passivation
                    description = "Size-tunable quantum confinement effects. Discrete energy levels enhance radiative rates.";
                    indicatorClass = 'fluorescence-indicator';
                    break;
            }
            
            // Calculate additional physics parameters
            const totalRate = radiativeRate + nonRadiativeRate;
            const effectiveLifetime = 1 / totalRate * 1e6; // Convert to μs
            const photonFlux = power * 1e-2 * quantumEff; // Approximate photon flux
            const thermalVelocity = Math.sqrt(3 * 1.38e-23 * temperature / 9.109e-31) / 1000; // km/s
            
            // Update display values
            document.getElementById('lifetimeValue').textContent = lifetime.toFixed(2);
            document.getElementById('currentLifetime').textContent = effectiveLifetime.toFixed(2);
            document.getElementById('quantumEfficiency').textContent = (quantumEff * 100).toFixed(1);
            document.getElementById('peakWavelength').textContent = wavelength.toFixed(0);
            
            // Enhanced information display
            document.getElementById('emissionInfo').innerHTML = `
                <strong>${type.charAt(0).toUpperCase() + type.slice(1)} Mechanism:</strong><br>
                ${description}<br><br>
                <div class="info-grid">
                    <div class="info-metric">
                        <div class="info-metric-value">${(radiativeRate/1e6).toFixed(2)}</div>
                        <div class="info-metric-label">Radiative Rate (MHz)</div>
                    </div>
                    <div class="info-metric">
                        <div class="info-metric-value">${(nonRadiativeRate/1e6).toFixed(2)}</div>
                        <div class="info-metric-label">Non-Radiative (MHz)</div>
                    </div>
                    <div class="info-metric">
                        <div class="info-metric-value">${photonFlux.toFixed(1)}</div>
                        <div class="info-metric-label">Photon Flux (%)</div>
                    </div>
                    <div class="info-metric">
                        <div class="info-metric-value">${thermalVelocity.toFixed(0)}</div>
                        <div class="info-metric-label">Thermal v (km/s)</div>
                    </div>
                </div>
                <div class="mechanism-flow">
                    <div class="flow-step">Excitation</div>
                    <div class="flow-arrow">→</div>
                    <div class="flow-step">${type === 'phosphorescence' ? 'Intersystem Crossing' : 'Direct Transition'}</div>
                    <div class="flow-arrow">→</div>
                    <div class="flow-step">Emission</div>
                </div>
            `;
            
            // Update emission indicator
            const indicator = document.getElementById('emissionIndicator');
            indicator.className = `emission-type-indicator ${indicatorClass}`;
            indicator.textContent = type.charAt(0).toUpperCase() + type.slice(1);
            
            // Update trap level visibility and add physics details
            const trapLevel = document.getElementById('trapLevel');
            if (type === 'phosphorescence') {
                trapLevel.style.display = 'block';
                trapLevel.style.opacity = '1';
            } else {
                trapLevel.style.opacity = type === 'quantum_dots' ? '0.5' : '0.2';
            }
            
            // Add emission legend
            addEmissionLegend();
            
            drawLifetimePlot();
        }

        function addEmissionLegend() {
            const timeline = document.getElementById('emissionTimeline');
            
            // Remove existing legend
            const existingLegend = timeline.querySelector('.simulation-legend');
            if (existingLegend) {
                existingLegend.remove();
            }
            
            // Add legend toggle button
            let toggleButton = timeline.querySelector('.legend-toggle');
            if (!toggleButton) {
                toggleButton = document.createElement('button');
                toggleButton.className = 'legend-toggle';
                toggleButton.innerHTML = '?';
                toggleButton.title = 'Toggle Emission Physics Legend';
                toggleButton.onclick = () => toggleEmissionLegend();
                timeline.appendChild(toggleButton);
            }
            
            const type = document.getElementById('emissionType').value;
            
            // Create compact emission legend
            const legend = document.createElement('div');
            legend.className = 'simulation-legend';
            legend.id = 'emission-legend';
            legend.innerHTML = `
                <div class="legend-header">
                    <div class="legend-title">Carrier Dynamics</div>
                    <button class="legend-collapse-btn" onclick="collapseLegend('emission-legend')" title="Collapse">−</button>
                </div>
                <div class="legend-content">
                    <div class="legend-section">
                        <div class="legend-section-title">Carriers</div>
                        <div class="legend-item">
                            <div class="legend-symbol electron">e*</div>
                            <div class="legend-text">Excited Carrier</div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-symbol emission">hν</div>
                            <div class="legend-text">Emitted Photon</div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-symbol trap">T</div>
                            <div class="legend-text">Trap States</div>
                        </div>
                    </div>
                    <div class="legend-section">
                        <div class="legend-section-title">Levels</div>
                        <div class="legend-item">
                            <div class="legend-symbol band"></div>
                            <div class="legend-text">Conduction Band</div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-symbol band" style="background: linear-gradient(45deg, #ef4444, #dc2626);"></div>
                            <div class="legend-text">Valence Band</div>
                        </div>
                    </div>
                </div>
            `;
            
            timeline.appendChild(legend);
            
            // Add mechanism-specific quick info
            const quickInfo = document.createElement('div');
            quickInfo.className = 'quick-info';
            quickInfo.id = 'emission-quick-info';
            quickInfo.innerHTML = `
                <div class="quick-info-title">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
                ${getQuickEmissionInfo(type)}
            `;
            timeline.appendChild(quickInfo);
        }

        function getQuickEmissionInfo(type) {
            switch(type) {
                case 'fluorescence':
                    return 'I(t) = I₀×exp(-t/τ)<br>Fast S₁→S₀ (ns-μs)';
                case 'phosphorescence':
                    return 'I(t) = I₀×exp(-(t/τ)^β)<br>Slow T₁→S₀ (ms-s)';
                case 'led':
                    return 'I = η×(I/q)×hν<br>Band-to-band';
                case 'quantum_dots':
                    return 'E = E_bulk + ℏ²π²/(2m*R²)<br>Size-tunable';
                default:
                    return 'Carrier recombination';
            }
        }

        function toggleEmissionLegend() {
            const legend = document.getElementById('emission-legend');
            const quickInfo = document.getElementById('emission-quick-info');
            const button = document.querySelector('#emissionTimeline .legend-toggle');
            
            if (legend) {
                legend.classList.toggle('visible');
                if (quickInfo) quickInfo.classList.toggle('visible');
                button.classList.toggle('active');
            }
        }

        function updateExcitation() {
            const power = document.getElementById('excitationPower').value;
            document.getElementById('excitationValue').textContent = power;
            updateEmission();
        }

        function updateLifetime() {
            const lifetime = document.getElementById('carrierLifetime').value;
            document.getElementById('lifetimeValue').textContent = parseFloat(lifetime).toFixed(2);
            document.getElementById('currentLifetime').textContent = parseFloat(lifetime).toFixed(2);
            updateEmission();
        }

        function updateEmissionTemp() {
            const temp = document.getElementById('emissionTemperature').value;
            document.getElementById('emissionTempValue').textContent = temp;
            updateEmission();
        }

        function startEmission() {
            emissionActive = true;
            animateCarrierRecombination();
            animateEmissionResponse();
        }

        function pulseExcitation() {
            if (emissionActive) {
                stopEmission();
                return;
            }
            
            // Single pulse excitation
            emissionActive = true;
            animateCarrierRecombination();
            
            setTimeout(() => {
                emissionActive = false;
            }, 2000);
        }

        function stopEmission() {
            emissionActive = false;
            if (emissionAnimationId) {
                clearTimeout(emissionAnimationId);
                emissionAnimationId = null;
            }
            document.getElementById('currentIntensity').textContent = '0';
        }

        function animateCarrierRecombination() {
            if (!emissionActive) return;
            
            const timeline = document.getElementById('emissionTimeline');
            const type = document.getElementById('emissionType').value;
            const lifetime = parseFloat(document.getElementById('carrierLifetime').value);
            const power = parseFloat(document.getElementById('excitationPower').value);
            
            // Clear existing carriers
            timeline.querySelectorAll('.excited-carrier, .photon-emission, .trap-state, .recombination-zone').forEach(el => el.remove());
            
            // Create multiple excited carriers based on power
            const numCarriers = Math.max(2, Math.floor(power / 25));
            
            for (let i = 0; i < numCarriers; i++) {
                setTimeout(() => {
                    if (!emissionActive) return;
                    
                    const carrier = document.createElement('div');
                    carrier.className = 'excited-carrier';
                    carrier.style.left = `${15 + Math.random() * 70}%`;
                    carrier.style.top = '20%';
                    timeline.appendChild(carrier);
                    
                    // Handle different emission pathways
                    if (type === 'phosphorescence' && Math.random() > 0.4) {
                        // Move to trap state first
                        setTimeout(() => {
                            if (!emissionActive) return;
                            
                            carrier.style.top = '60%';
                            carrier.style.background = 'radial-gradient(circle, #f59e0b, #d97706)';
                            carrier.style.border = '2px solid #d97706';
                            
                            // Delayed emission from trap
                            setTimeout(() => {
                                createEmissionEvent(carrier, timeline, lifetime * 3);
                            }, lifetime * 1000);
                        }, 300);
                    } else {
                        // Direct recombination
                        setTimeout(() => {
                            createEmissionEvent(carrier, timeline, lifetime);
                        }, type === 'fluorescence' ? lifetime * 100 : lifetime * 500);
                    }
                }, i * 200);
            }
            
            // Schedule next animation cycle
            emissionAnimationId = setTimeout(() => {
                if (emissionActive) animateCarrierRecombination();
            }, 3000);
        }

        function createEmissionEvent(carrier, timeline, baseLifetime) {
            if (!emissionActive || !carrier.parentNode) return;
            
            // Move carrier to valence band
            carrier.style.top = '85%';
            carrier.style.background = 'radial-gradient(circle, #ef4444, #dc2626)';
            carrier.style.border = '2px solid #dc2626';
            
            // Create photon emission
            const photon = document.createElement('div');
            photon.className = 'photon-emission';
            photon.style.left = carrier.style.left;
            photon.style.top = carrier.style.top;
            
            const type = document.getElementById('emissionType').value;
            if (type === 'quantum_dots') {
                photon.style.background = 'radial-gradient(circle, #8b5cf6 30%, #7c3aed 70%, #6d28d9 100%)';
                photon.style.boxShadow = '0 0 20px rgba(139, 92, 246, 0.8)';
            }
            
            timeline.appendChild(photon);
            
            // Cleanup
            setTimeout(() => {
                if (carrier.parentNode) carrier.remove();
                if (photon.parentNode) photon.remove();
            }, 2000);
        }

        function animateEmissionResponse() {
            if (!emissionActive) return;
            
            const power = parseFloat(document.getElementById('excitationPower').value);
            const lifetime = parseFloat(document.getElementById('carrierLifetime').value);
            const type = document.getElementById('emissionType').value;
            
            let intensity = 0;
            const startTime = Date.now();
            
            function updateIntensity() {
                if (!emissionActive) return;
                
                const elapsed = (Date.now() - startTime) / 1000;
                
                // Build-up phase
                let targetIntensity = power;
                if (type === 'phosphorescence') {
                    targetIntensity *= 0.6; // Lower efficiency
                } else if (type === 'quantum_dots') {
                    targetIntensity *= 1.2; // High efficiency
                }
                
                intensity = targetIntensity * (1 - Math.exp(-elapsed / (lifetime * 0.1)));
                
                document.getElementById('currentIntensity').textContent = Math.round(intensity);
                
                if (emissionActive) {
                    requestAnimationFrame(updateIntensity);
                }
            }
            
            updateIntensity();
        }

        function drawLifetimePlot() {
            try {
                const currentType = document.getElementById('emissionType').value;
                const currentLifetime = parseFloat(document.getElementById('carrierLifetime').value);
                const temperature = parseFloat(document.getElementById('emissionTemperature').value);
                
                const timeRange = [];
                const traces = [];
                
                const emissionTypes = [
                    { name: 'Fluorescence', lifetime: 0.05, color: '#0891b2', type: 'fluorescence' },
                    { name: 'Phosphorescence', lifetime: 10, color: '#8b5cf6', type: 'phosphorescence' },
                    { name: 'LED', lifetime: 2, color: '#ef4444', type: 'led' },
                    { name: 'Quantum Dots', lifetime: 1, color: '#10b981', type: 'quantum_dots' }
                ];
                
                const maxTime = Math.max(50, currentLifetime * 5);
                for (let t = 0; t <= maxTime; t += maxTime / 500) {
                    timeRange.push(t);
                }
                
                emissionTypes.forEach(emType => {
                    const intensityValues = [];
                    const effectiveLifetime = emType.type === currentType ? currentLifetime : emType.lifetime;
                    
                    timeRange.forEach(t => {
                        let intensity;
                        
                        if (emType.type === 'phosphorescence') {
                            const beta = 0.7;
                            intensity = 100 * Math.exp(-Math.pow(t / effectiveLifetime, beta));
                        } else if (emType.type === 'quantum_dots') {
                            intensity = 100 * (0.7 * Math.exp(-t / effectiveLifetime) + 
                                              0.3 * Math.exp(-t / (effectiveLifetime * 2)));
                        } else {
                            intensity = 100 * Math.exp(-t / effectiveLifetime);
                        }
                        
                        const tempFactor = Math.exp(-(temperature - 300) / 200);
                        intensity *= tempFactor;
                        
                        intensityValues.push(Math.max(intensity, 0.01));
                    });
                    
                    const trace = {
                        x: timeRange,
                        y: intensityValues,
                        type: 'scatter',
                        mode: 'lines',
                        line: {
                            color: emType.color,
                            width: emType.type === currentType ? 4 : 2,
                            dash: emType.type === currentType ? 'solid' : 'dot'
                        },
                        name: `${emType.name} (τ=${effectiveLifetime}μs)`,
                        opacity: emType.type === currentType ? 1 : 0.6,
                        hovertemplate: `<b>${emType.name}</b><br>` +
                                      `Time: %{x:.3f} μs<br>` +
                                      `Intensity: %{y:.2f}%<br>` +
                                      `Lifetime: ${effectiveLifetime} μs<br>` +
                                      `<extra></extra>`
                    };
                    
                    traces.push(trace);
                });
                
                const layout = {
                    title: {
                        text: `Carrier Recombination Dynamics (T=${temperature}K)`,
                        font: { family: 'Poppins', size: 16 }
                    },
                    xaxis: {
                        title: 'Time (μs)',
                        type: 'log',
                        gridcolor: '#e5e7eb'
                    },
                    yaxis: {
                        title: 'Normalized Intensity (%)',
                        type: 'log',
                        range: [-2, 2],
                        gridcolor: '#e5e7eb'
                    },
                    plot_bgcolor: '#f8fafc',
                    paper_bgcolor: 'white',
                    font: { family: 'Poppins', size: 11 },
                    margin: { t: 40, r: 50, b: 50, l: 70 },
                    height: 300,
                    showlegend: true,
                    legend: {
                        x: 0.01,
                        y: 0.01,
                        bgcolor: 'rgba(255,255,255,0.95)',
                        bordercolor: '#d1d5db',
                        borderwidth: 1,
                        font: { size: 10 }
                    }
                };
                
                const config = { responsive: true, displayModeBar: false };
                Plotly.newPlot('lifetimePlot', traces, layout, config);
                
            } catch (error) {
                console.error('Error drawing lifetime plot:', error);
            }
        }

        function applyEmissionPreset(emissionType) {
            const presets = {
                'fluorescence': { type: 'fluorescence', power: 80, lifetime: 0.05, temp: 300 },
                'phosphorescence': { type: 'phosphorescence', power: 60, lifetime: 10, temp: 300 },
                'led': { type: 'led', power: 90, lifetime: 2, temp: 300 },
                'quantum_dots': { type: 'quantum_dots', power: 95, lifetime: 1, temp: 300 }
            };
            
            const preset = presets[emissionType];
            if (!preset) return;
            
            document.getElementById('emissionType').value = preset.type;
            document.getElementById('excitationPower').value = preset.power;
            document.getElementById('carrierLifetime').value = preset.lifetime;
            document.getElementById('emissionTemperature').value = preset.temp;
            
            updateEmission();
        }

        // ========== CHALLENGE SYSTEM FUNCTIONS ==========
        
        function generateNewQuestions() {
            selectedQuestions.mcq = getRandomQuestions(mcqQuestionBank, 5);
            selectedQuestions.fillBlanks = getRandomQuestions(fillBlankQuestionBank, 3);
            selectedQuestions.advanced = getRandomQuestions(advancedQuestionBank, 3);
            selectedQuestions.calculations = getRandomQuestions(calculationQuestionBank, 3);
            
            generateChallengeContent();
            resetAllChallenges();
            updateChallengeStats();
        }
        
        function getRandomQuestions(questionBank, count) {
            const shuffled = [...questionBank].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }
        
        function generateChallengeContent() {
            generateMCQContent();
            generateFillBlankContent();
            generateAdvancedContent();
            generateCalculationContent();
        }
        
        function generateMCQContent() {
            const container = document.getElementById('mcqQuestions');
            container.innerHTML = '';
            
            selectedQuestions.mcq.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'quiz-question';
                questionDiv.innerHTML = `
                    <h4>Question ${index + 1}: ${q.question}</h4>
                    <div class="quiz-options">
                        ${q.options.map((option, optIndex) => 
                            `<div class="quiz-option" onclick="selectMCQOption(${index}, ${optIndex})" data-question="${index}" data-option="${optIndex}">
                                ${option}
                            </div>`
                        ).join('')}
                    </div>
                    <div class="explanation-panel" id="mcq-explanation-${index}" style="display: none; margin-top: 15px; padding: 15px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #0284c7;">
                        <div style="font-weight: 600; color: #0c4a6e; margin-bottom: 8px;">
                            <i class="fas fa-lightbulb"></i> Explanation
                        </div>
                        <div style="color: #075985; line-height: 1.5;">${q.explanation}</div>
                    </div>
                `;
                container.appendChild(questionDiv);
            });
        }
        
        function selectMCQOption(questionIndex, optionIndex) {
            document.querySelectorAll(`[data-question="${questionIndex}"]`).forEach(opt => {
                opt.classList.remove('selected');
            });
            
            event.target.classList.add('selected');
            challengeAnswers.mcq[questionIndex] = optionIndex;
        }
        
        function checkMCQAnswers() {
            let correct = 0;
            let total = selectedQuestions.mcq.length;
            
            selectedQuestions.mcq.forEach((question, index) => {
                const userAnswer = challengeAnswers.mcq[index];
                const correctAnswer = question.correct;
                const questionElement = document.querySelectorAll(`[data-question="${index}"]`);
                
                questionElement.forEach(opt => {
                    opt.classList.remove('correct', 'incorrect');
                });
                
                questionElement[correctAnswer].classList.add('correct');
                
                if (userAnswer !== undefined && userAnswer !== correctAnswer) {
                    questionElement[userAnswer].classList.add('incorrect');
                } else if (userAnswer === correctAnswer) {
                    correct++;
                }
                
                document.getElementById(`mcq-explanation-${index}`).style.display = 'block';
            });
            
            const feedback = document.getElementById('challenge1-feedback');
            const percentage = Math.round((correct / total) * 100);
            
            if (percentage >= 80) {
                feedback.className = 'challenge-feedback success';
                feedback.textContent = `Excellent! ${correct}/${total} correct (${percentage}%). You have a strong understanding of photonic fundamentals!`;
                if (!challengeStats.mcqCompleted) {
                    challengeStats.completed++;
                    challengeStats.score += percentage;
                    challengeStats.mcqCompleted = true;
                }
            } else {
                feedback.className = 'challenge-feedback error';
                feedback.textContent = `Good effort! ${correct}/${total} correct (${percentage}%). Review the explanations and try again.`;
            }
            
            updateChallengeStats();
        }
        
        function generateFillBlankContent() {
            const container = document.getElementById('fillBlankQuestions');
            container.innerHTML = '';
            
            selectedQuestions.fillBlanks.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'quiz-question';
                
                let textWithBlanks = q.text;
                q.blanks.forEach((blank, blankIndex) => {
                    const inputField = `<input type="text" class="fill-blank-input" data-question="${index}" data-blank="${blankIndex}" placeholder="?" style="display: inline-block; width: 120px; padding: 4px 8px; border: 2px solid #6366f1; border-radius: 4px; text-align: center; font-weight: 600; margin: 0 5px; background: white;">`;
                    textWithBlanks = textWithBlanks.replace('_____', inputField);
                });
                
                questionDiv.innerHTML = `
                    <h4>Fill in the blanks ${index + 1}:</h4>
                    <div style="font-size: 1rem; line-height: 2; color: #1f2937; margin: 15px 0;">${textWithBlanks}</div>
                    <div class="explanation-panel" id="fill-explanation-${index}" style="display: none; margin-top: 15px; padding: 15px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #0284c7;">
                        <div style="font-weight: 600; color: #0c4a6e; margin-bottom: 8px;">
                            <i class="fas fa-lightbulb"></i> Explanation
                        </div>
                        <div style="color: #075985; line-height: 1.5;">${q.explanation}</div>
                    </div>
                `;
                container.appendChild(questionDiv);
            });
        }
        
        function checkFillBlanks() {
            let correct = 0;
            let total = 0;
            
            selectedQuestions.fillBlanks.forEach((question, qIndex) => {
                question.blanks.forEach((correctAnswer, bIndex) => {
                    total++;
                    const input = document.querySelector(`[data-question="${qIndex}"][data-blank="${bIndex}"]`);
                    const userAnswer = input.value.trim().toLowerCase();
                    const correctLower = correctAnswer.toLowerCase();
                    
                    if (userAnswer === correctLower || correctLower.includes(userAnswer) && userAnswer.length > 2) {
                        input.style.borderColor = '#10b981';
                        input.style.background = '#f0fdf4';
                        input.style.color = '#065f46';
                        correct++;
                    } else {
                        input.style.borderColor = '#ef4444';
                        input.style.background = '#fef2f2';
                        input.style.color = '#991b1b';
                        input.placeholder = correctAnswer;
                    }
                });
                
                document.getElementById(`fill-explanation-${qIndex}`).style.display = 'block';
            });
            
            const feedback = document.getElementById('challenge2-feedback');
            const percentage = Math.round((correct / total) * 100);
            
            if (percentage >= 80) {
                feedback.className = 'challenge-feedback success';
                feedback.textContent = `Excellent! ${correct}/${total} blanks correct (${percentage}%). Great knowledge of photonic terminology!`;
                if (!challengeStats.fillCompleted) {
                    challengeStats.completed++;
                    challengeStats.score += percentage;
                    challengeStats.fillCompleted = true;
                }
            } else {
                feedback.className = 'challenge-feedback error';
                feedback.textContent = `Good effort! ${correct}/${total} blanks correct (${percentage}%). Check the correct answers shown.`;
            }
            
            updateChallengeStats();
        }
        
        function generateAdvancedContent() {
            const container = document.getElementById('advancedQuestions');
            container.innerHTML = '';
            
            selectedQuestions.advanced.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'quiz-question';
                questionDiv.innerHTML = `
                    <h4>Advanced Question ${index + 1}: ${q.question}</h4>
                    <div class="quiz-options">
                        ${q.options.map((option, optIndex) => 
                            `<div class="quiz-option" onclick="selectAdvancedOption(${index}, ${optIndex})" data-question="adv-${index}" data-option="${optIndex}">
                                ${option}
                            </div>`
                        ).join('')}
                    </div>
                    <div class="explanation-panel" id="adv-explanation-${index}" style="display: none; margin-top: 15px; padding: 15px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #0284c7;">
                        <div style="font-weight: 600; color: #0c4a6e; margin-bottom: 8px;">
                            <i class="fas fa-graduation-cap"></i> Advanced Explanation
                        </div>
                        <div style="color: #075985; line-height: 1.5;">${q.explanation}</div>
                    </div>
                `;
                container.appendChild(questionDiv);
            });
        }
        
        function selectAdvancedOption(questionIndex, optionIndex) {
            document.querySelectorAll(`[data-question="adv-${questionIndex}"]`).forEach(opt => {
                opt.classList.remove('selected');
            });
            
            event.target.classList.add('selected');
            if (!challengeAnswers.advanced) challengeAnswers.advanced = [];
            challengeAnswers.advanced[questionIndex] = optionIndex;
        }
        
        function checkAdvancedAnswers() {
            let correct = 0;
            let total = selectedQuestions.advanced.length;
            
            selectedQuestions.advanced.forEach((question, index) => {
                const userAnswer = challengeAnswers.advanced ? challengeAnswers.advanced[index] : undefined;
                const correctAnswer = question.correct;
                const questionElement = document.querySelectorAll(`[data-question="adv-${index}"]`);
                
                questionElement.forEach(opt => {
                    opt.classList.remove('correct', 'incorrect');
                });
                
                questionElement[correctAnswer].classList.add('correct');
                
                if (userAnswer !== undefined && userAnswer !== correctAnswer) {
                    questionElement[userAnswer].classList.add('incorrect');
                } else if (userAnswer === correctAnswer) {
                    correct++;
                }
                
                document.getElementById(`adv-explanation-${index}`).style.display = 'block';
            });
            
            const feedback = document.getElementById('challenge3-feedback');
            const percentage = Math.round((correct / total) * 100);
            
            if (percentage >= 80) {
                feedback.className = 'challenge-feedback success';
                feedback.textContent = `Outstanding! ${correct}/${total} correct (${percentage}%). You have mastered advanced photonic concepts!`;
                if (!challengeStats.advancedCompleted) {
                    challengeStats.completed++;
                    challengeStats.score += percentage;
                    challengeStats.advancedCompleted = true;
                }
            } else {
                feedback.className = 'challenge-feedback error';
                feedback.textContent = `Good work! ${correct}/${total} correct (${percentage}%). These are challenging concepts - review the explanations.`;
            }
            
            updateChallengeStats();
        }
        
        function generateCalculationContent() {
            const container = document.getElementById('calculationQuestions');
            container.innerHTML = '';
            
            selectedQuestions.calculations.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'quiz-question';
                questionDiv.innerHTML = `
                    <h4>Problem ${index + 1}: ${q.question}</h4>
                    <div style="margin: 15px 0; padding: 10px; background: #f0f9ff; border-radius: 6px; border-left: 4px solid #0284c7;">
                        <strong>Formula:</strong> ${q.formula}
                    </div>
                    <div style="margin: 10px 0;">
                        <label style="display: block; font-weight: 500; margin-bottom: 6px; color: #374151; font-size: 13px;">Your Answer:</label>
                        <input type="number" step="0.001" class="control-input" data-calc="${index}" placeholder="Enter value" style="width: 150px; display: inline-block; margin-right: 10px;">
                        <span style="font-weight: 500;">${q.unit}</span>
                    </div>
                    <div class="explanation-panel" id="calc-explanation-${index}" style="display: none; margin-top: 15px; padding: 15px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #0284c7;">
                        <div style="font-weight: 600; color: #0c4a6e; margin-bottom: 8px;">
                            <i class="fas fa-calculator"></i> Solution
                        </div>
                        <div style="color: #075985; line-height: 1.5; font-family: 'Courier New', monospace;">
                            <strong>Answer:</strong> ${q.answer} ${q.unit}<br>
                            <strong>Step-by-step:</strong> ${q.explanation}
                        </div>
                    </div>
                `;
                container.appendChild(questionDiv);
            });
        }
        
        function checkCalculations() {
            let correct = 0;
            let total = selectedQuestions.calculations.length;
            
            selectedQuestions.calculations.forEach((question, index) => {
                const input = document.querySelector(`[data-calc="${index}"]`);
                const userAnswer = parseFloat(input.value);
                const correctAnswer = parseFloat(question.answer);
                const tolerance = Math.max(0.05 * correctAnswer, 0.001);
                
                if (!isNaN(userAnswer) && Math.abs(userAnswer - correctAnswer) <= tolerance) {
                    input.style.borderColor = '#10b981';
                    input.style.background = '#f0fdf4';
                    input.style.color = '#065f46';
                    correct++;
                } else {
                    input.style.borderColor = '#ef4444';
                    input.style.background = '#fef2f2';
                    input.style.color = '#991b1b';
                }
                
                document.getElementById(`calc-explanation-${index}`).style.display = 'block';
            });
            
            const feedback = document.getElementById('challenge4-feedback');
            const percentage = Math.round((correct / total) * 100);
            
            if (percentage >= 70) {
                feedback.className = 'challenge-feedback success';
                feedback.textContent = `Excellent! ${correct}/${total} calculations correct (${percentage}%). Strong problem-solving skills!`;
                if (!challengeStats.calcCompleted) {
                    challengeStats.completed++;
                    challengeStats.score += percentage;
                    challengeStats.calcCompleted = true;
                }
            } else {
                feedback.className = 'challenge-feedback error';
                feedback.textContent = `Good attempt! ${correct}/${total} calculations correct (${percentage}%). Check the solutions and formulas.`;
            }
            
            updateChallengeStats();
        }
        
        function resetChallenge(challengeNumber) {
            const feedbackId = `challenge${challengeNumber}-feedback`;
            const feedback = document.getElementById(feedbackId);
            if (feedback) {
                feedback.className = 'challenge-feedback';
                feedback.textContent = '';
            }
            
            if (challengeNumber === 1) {
                challengeAnswers.mcq = [];
                document.querySelectorAll('.quiz-option').forEach(opt => {
                    opt.classList.remove('selected', 'correct', 'incorrect');
                });
                document.querySelectorAll('[id^="mcq-explanation-"]').forEach(exp => {
                    exp.style.display = 'none';
                });
            } else if (challengeNumber === 2) {
                document.querySelectorAll('.fill-blank-input').forEach(input => {
                    input.value = '';
                    input.style.borderColor = '#6366f1';
                    input.style.background = 'white';
                    input.style.color = '#000';
                    input.placeholder = '?';
                });
                document.querySelectorAll('[id^="fill-explanation-"]').forEach(exp => {
                    exp.style.display = 'none';
                });
            } else if (challengeNumber === 3) {
                challengeAnswers.advanced = [];
                document.querySelectorAll('[data-question^="adv-"]').forEach(opt => {
                    opt.classList.remove('selected', 'correct', 'incorrect');
                });
                document.querySelectorAll('[id^="adv-explanation-"]').forEach(exp => {
                    exp.style.display = 'none';
                });
            } else if (challengeNumber === 4) {
                document.querySelectorAll('[data-calc]').forEach(input => {
                    input.value = '';
                    input.style.borderColor = '#e5e7eb';
                    input.style.background = 'white';
                    input.style.color = '#000';
                });
                document.querySelectorAll('[id^="calc-explanation-"]').forEach(exp => {
                    exp.style.display = 'none';
                });
            }
        }
        
        function resetAllChallenges() {
            for (let i = 1; i <= 4; i++) {
                resetChallenge(i);
            }
            challengeStats = { completed: 0, total: 4, score: 0 };
            updateChallengeStats();
        }
        
        function updateChallengeStats() {
            document.getElementById('completedChallenges').textContent = challengeStats.completed;
            document.getElementById('challengeScore').textContent = Math.round(challengeStats.score);
            
            const progress = (challengeStats.completed / challengeStats.total) * 100;
            document.getElementById('overallProgress').style.width = `${progress}%`;
            
            // Update mastery level
            const avgScore = challengeStats.completed > 0 ? challengeStats.score / challengeStats.completed : 0;
            let masteryLevel = 'Beginner';
            if (avgScore >= 90) masteryLevel = 'Expert';
            else if (avgScore >= 80) masteryLevel = 'Advanced';
            else if (avgScore >= 70) masteryLevel = 'Intermediate';
            
            document.getElementById('masteryLevel').textContent = masteryLevel;
            
            if (challengeStats.completed === challengeStats.total) {
                setTimeout(() => {
                    showCompletionCelebration();
                }, 1000);
            }
        }
        
        function showCompletionCelebration() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                z-index: 100000;
                display: flex;
                justify-content: center;
                align-items: center;
                animation: fadeIn 0.5s ease-out;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    padding: 40px;
                    border-radius: 20px;
                    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                    text-align: center;
                    max-width: 500px;
                    margin: 20px;
                    animation: popIn 0.6s ease-out;
                ">
                    <div style="font-size: 4rem; margin-bottom: 20px;">🏆</div>
                    <h2 style="
                        font-size: 2rem;
                        font-weight: 700;
                        color: #1f2937;
                        margin-bottom: 15px;
                        background: linear-gradient(135deg, #6366f1, #8b5cf6);
                        background-clip: text;
                        -webkit-background-clip: text;
                        -webkit-text-fill-color: transparent;
                    ">
                        🎉 Photonics Master! 🎉
                    </h2>
                    <p style="
                        color: #4b5563;
                        font-size: 1.1rem;
                        line-height: 1.6;
                        margin-bottom: 25px;
                    ">
                        Congratulations! You've mastered all photonic device challenges with a score of ${Math.round(challengeStats.score)} points!
                    </p>
                    <button onclick="closeCompletionModal()" style="
                        background: linear-gradient(135deg, #6366f1, #8b5cf6);
                        color: white;
                        border: none;
                        padding: 12px 30px;
                        border-radius: 8px;
                        font-weight: 600;
                        cursor: pointer;
                        font-size: 1rem;
                        transition: all 0.2s;
                        margin-top: 20px;
                    ">
                        🚀 Continue Exploring
                    </button>
                </div>
            `;
            
            modal.id = 'challengeCompletionModal';
            document.body.appendChild(modal);
        }
        
        function closeCompletionModal() {
            const modal = document.getElementById('challengeCompletionModal');
            if (modal) {
                modal.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => {
                    document.body.removeChild(modal);
                }, 300);
            }
        }
        
        // Hint functions
        function showMCQHints() {
            alert('💡 Hints:\n• Focus on fundamental physics of photon-semiconductor interactions\n• Consider energy conservation and quantum mechanics\n• Think about direct vs. indirect bandgap differences\n• Remember quantum efficiency definitions');
        }
        
        function showFillBlanksHint() {
            alert('💡 Hint: Think about energy relationships, quantum mechanics terms, and fundamental processes in semiconductor devices.');
        }
        
        function showAdvancedHints() {
            alert('💡 Advanced Concepts: These questions require deeper understanding of quantum mechanics and advanced semiconductor physics. Consider carrier confinement and temperature effects.');
        }
        
        function showCalculationHint() {
            alert('💡 Calculation Tips: Use the provided formulas carefully. Remember: hc = 1.24 eV·μm is very useful for photon energy calculations.');
        }

        // Tour variables
        let tourActive = false;
        let currentTourStep = 0;
        let tourScore = 0;
        let conceptsLearned = 0;
        let helpPanelVisible = false;
        
        // Tour steps definition
        const tourSteps = [
            // Step 1: Welcome
            {
                title: "Welcome to the Photonics Lab",
                content: "This interactive lab helps you understand how photons interact with semiconductor materials. You'll explore absorption, emission, and carrier dynamics through visualizations and simulations.",
                element: ".lab-header",
                position: "bottom",
                width: 300,
                height: 100
            },
            // Step 2: Module Navigation
            {
                title: "Module Navigation",
                content: "Use these tabs to switch between different experiment modules. Each module focuses on a specific aspect of photon-semiconductor interactions.",
                element: ".module-tabs",
                position: "bottom",
                width: 400,
                height: 50
            },
            // Step 3: Absorption Module Overview
            {
                title: "Quantum Absorption Module",
                content: "In this module, you'll explore how semiconductors absorb photons. The energy of the photon must be greater than the material's bandgap for absorption to occur.",
                element: "#module-0",
                position: "center",
                width: 800,
                height: 400,
                action: function() { switchModule(0); }
            },
            // Step 4: Band Diagram
            {
                title: "Band Diagram Visualization",
                content: "This visualization shows the energy band structure of semiconductors. The conduction band (blue) and valence band (red) are separated by the bandgap. When a photon with sufficient energy is absorbed, electrons move from the valence to the conduction band.",
                element: ".band-diagram",
                position: "right",
                width: 400,
                height: 300
            },
            // Step 5: Material Controls
            {
                title: "Material Selection",
                content: "Choose different semiconductor materials to see how their bandgap and absorption properties differ. Silicon, GaAs, and other materials each have unique optical properties.",
                element: "#material",
                position: "left",
                width: 400,
                height: 65,
                spotlight: true,
                transparentBackground: true,
                action: function() {
                    // Make sure overlay is transparent
                    document.getElementById('tourOverlay').style.background = 'transparent';
                    document.getElementById('tourSpotlight').style.boxShadow = '0 0 0 99999px rgba(0, 0, 0, 0)';
                    
                    // Fix the position of the spotlight to align with the dropdown
                    setTimeout(() => {
                        const spotlight = document.getElementById('tourSpotlight');
                        const spotlightTop = parseInt(spotlight.style.top);
                        spotlight.style.top = (spotlightTop - 15) + 'px'; // Adjust upward by 15px
                    }, 50);
                }
            },
            // Step 6: Photon Energy
            {
                title: "Photon Energy Control",
                content: "Adjust the photon energy to see how it affects absorption. Remember that absorption only occurs when the photon energy exceeds the material's bandgap.",
                element: "#photonEnergy",
                position: "left",
                width: 450,
                height: 65,
                spotlight: true,
                transparentBackground: true,
                challenge: {
                    title: "Try It Yourself",
                    content: "Set the photon energy to a value above Silicon's bandgap (>1.1 eV) and click 'Animate Absorption'."
                },
                action: function() {
                    // Make sure overlay is transparent
                    document.getElementById('tourOverlay').style.background = 'transparent';
                    document.getElementById('tourSpotlight').style.boxShadow = '0 0 0 99999px rgba(0, 0, 0, 0)';
                    
                    // Fix the position of the spotlight to align with the slider
                    setTimeout(() => {
                        const spotlight = document.getElementById('tourSpotlight');
                        const spotlightTop = parseInt(spotlight.style.top);
                        spotlight.style.top = (spotlightTop - 20) + 'px'; // Adjust upward by 20px
                    }, 50);
                }
            },
            // Step 7: Absorption Graph
            {
                title: "Absorption Coefficient Graph",
                content: "This graph shows how the absorption coefficient varies with photon energy. The sharp increase at the bandgap energy (red line) indicates where absorption begins to occur significantly.",
                element: "#absorptionPlot",
                position: "right",
                width: 400,
                height: 300
            },
            // Step 8: Emission Module
            {
                title: "Carrier Dynamics Module",
                content: "This module shows what happens after absorption: electrons and holes can recombine to emit light. Different materials and conditions lead to different emission characteristics.",
                element: "#module-1",
                position: "center",
                width: 800,
                height: 400,
                action: function() { switchModule(1); }
            },
            // Step 9: Emission Timeline
            {
                title: "Emission Visualization",
                content: "This visualization shows the recombination of carriers and emission of photons. Observe how different types of materials (like LEDs or quantum dots) exhibit different emission behaviors.",
                element: ".emission-timeline",
                position: "right",
                width: 400,
                height: 300
            },
            // Step 10: Emission Type Selection
            {
                title: "Emission Type Selection",
                content: "Choose different emission mechanisms to explore. Fluorescence is a fast direct process, phosphorescence is slower and involves traps, LEDs use electroluminescence, and quantum dots confine carriers in small spaces.",
                element: "#emissionType",
                position: "left",
                width: 400,
                height: 65,
                spotlight: true,
                transparentBackground: true,
                action: function() {
                    // Make sure overlay is transparent
                    document.getElementById('tourOverlay').style.background = 'transparent';
                    document.getElementById('tourSpotlight').style.boxShadow = '0 0 0 99999px rgba(0, 0, 0, 0)';
                    
                    // Fix the position of the spotlight to align with the dropdown
                    setTimeout(() => {
                        const spotlight = document.getElementById('tourSpotlight');
                        const spotlightTop = parseInt(spotlight.style.top);
                        spotlight.style.top = (spotlightTop - 15) + 'px'; // Adjust upward by 15px
                    }, 50);
                }
            },
            // Step 11: Excitation Power
            {
                title: "Excitation Power Control",
                content: "Adjust the excitation power to change how many carriers are generated. Higher power means more carriers available for recombination, affecting the emission intensity.",
                element: "#excitationPower",
                position: "left",
                width: 450,
                height: 65,
                spotlight: true,
                transparentBackground: true,
                action: function() {
                    document.getElementById('tourOverlay').style.background = 'transparent';
                    document.getElementById('tourSpotlight').style.boxShadow = '0 0 0 99999px rgba(0, 0, 0, 0)';
                    
                    setTimeout(() => {
                        const spotlight = document.getElementById('tourSpotlight');
                        const spotlightTop = parseInt(spotlight.style.top);
                        spotlight.style.top = (spotlightTop - 20) + 'px';
                    }, 50);
                }
            },
            // Step 12: Carrier Lifetime
            {
                title: "Carrier Lifetime Control",
                content: "The carrier lifetime determines how long electrons and holes exist before recombining. Different materials and quality levels have different lifetimes, affecting emission duration and efficiency.",
                element: "#carrierLifetime",
                position: "left",
                width: 450,
                height: 65,
                spotlight: true,
                transparentBackground: true,
                action: function() {
                    document.getElementById('tourOverlay').style.background = 'transparent';
                    document.getElementById('tourSpotlight').style.boxShadow = '0 0 0 99999px rgba(0, 0, 0, 0)';
                    
                    setTimeout(() => {
                        const spotlight = document.getElementById('tourSpotlight');
                        const spotlightTop = parseInt(spotlight.style.top);
                        spotlight.style.top = (spotlightTop - 20) + 'px';
                    }, 50);
                }
            },
            // Step 13: Temperature Effect
            {
                title: "Temperature Effect",
                content: "Temperature affects carrier dynamics significantly. Higher temperatures increase non-radiative recombination, reducing emission efficiency. Quantum efficiency typically decreases as temperature increases.",
                element: "#emissionTemperature",
                position: "left",
                width: 450,
                height: 65,
                spotlight: true,
                transparentBackground: true,
                action: function() {
                    document.getElementById('tourOverlay').style.background = 'transparent';
                    document.getElementById('tourSpotlight').style.boxShadow = '0 0 0 99999px rgba(0, 0, 0, 0)';
                    
                    setTimeout(() => {
                        const spotlight = document.getElementById('tourSpotlight');
                        const spotlightTop = parseInt(spotlight.style.top);
                        spotlight.style.top = (spotlightTop - 20) + 'px';
                    }, 50);
                }
            },
            // Step 14: Challenges
            {
                title: "Knowledge Challenges",
                content: "Test your understanding with interactive quizzes and problems. These challenges cover the key concepts from the absorption and emission modules.",
                element: "#module-2",
                position: "center",
                width: 800,
                height: 400,
                action: function() { switchModule(2); }
            },
            // Step 15: Conclusion
            {
                title: "You're Ready to Explore!",
                content: "You've completed the guided tour. Now experiment with different parameters, try out the challenges, and deepen your understanding of photon-semiconductor interactions!",
                element: "body",
                position: "center",
                width: 300,
                height: 200
            }
        ];
        
        // Function to start the guided tour
        function startGuidedTour() {
            tourActive = true;
            currentTourStep = 0;
            tourScore = 0;
            conceptsLearned = 0;
            
            // Show tour overlay and score panel
            document.getElementById('tourOverlay').classList.add('active');
            document.getElementById('tourPopup').classList.add('active');
            document.getElementById('tourScore').classList.add('active');
            
            // Make overlay transparent to interactions
            document.getElementById('tourOverlay').style.pointerEvents = 'none';
            
            // Update score display
            updateTourScore();
            
            // Show first step
            showTourStep();
        }
        
        // Function to display the current tour step
        function showTourStep() {
            const step = tourSteps[currentTourStep];
            
            // Update step content
            document.getElementById('tourStepNumber').textContent = `Step ${currentTourStep + 1}/${tourSteps.length}`;
            document.getElementById('tourTitle').textContent = step.title;
            document.getElementById('tourContent').innerHTML = step.content;
            
            // Update progress bar
            const progress = ((currentTourStep + 1) / tourSteps.length) * 100;
            document.getElementById('tourProgress').style.width = `${progress}%`;
            
            // Position the tour elements
            positionTourElements(step);
            
            // Run any actions associated with this step
            if (step.action && typeof step.action === 'function') {
                step.action();
            }
            
            // Add challenge if present
            if (step.challenge) {
                document.getElementById('tourChallenge').innerHTML = `
                    <div class="tour-challenge">
                        <div class="tour-challenge-title">
                            <i class="fas fa-tasks"></i> ${step.challenge.title}
                        </div>
                        <div class="tour-challenge-content">
                            ${step.challenge.content}
                        </div>
                    </div>
                `;
            } else {
                document.getElementById('tourChallenge').innerHTML = '';
            }
            
            // Update navigation buttons
            const prevBtn = document.querySelector('.tour-btn-secondary');
            const nextBtn = document.querySelector('.tour-btn-primary');
            
            if (currentTourStep === 0) {
                prevBtn.textContent = 'Skip Tour';
                prevBtn.onclick = skipTour;
            } else {
                prevBtn.textContent = '← Previous';
                prevBtn.onclick = prevTourStep;
            }
            
            if (currentTourStep === tourSteps.length - 1) {
                nextBtn.textContent = 'Finish Tour';
                nextBtn.onclick = finalizeTour;
            } else {
                nextBtn.textContent = 'Next →';
                nextBtn.onclick = nextTourStep;
            }
            
            // Add 2 points for each step viewed
            tourScore += 2;
            conceptsLearned += 1;
            updateTourScore();
        }
        
        // Function to position tour elements based on the current step
        function positionTourElements(step) {
            // Clean up any existing highlights
            cleanupTourHighlights();
            
            // Get the target element
            let targetElement;
            try {
                targetElement = document.querySelector(step.element);
            } catch (e) {
                // If selector is invalid, use body as fallback
                targetElement = document.body;
            }
            
            // If no element or body is targeted, center the popup
            if (!targetElement || step.element === 'body' || step.position === 'center') {
                document.getElementById('tourPopup').style.top = '50%';
                document.getElementById('tourPopup').style.left = '50%';
                document.getElementById('tourPopup').style.transform = 'translate(-50%, -50%)';
                return;
            }
            
            // Get element dimensions and position
            const rect = targetElement.getBoundingClientRect();
            const spotlight = document.getElementById('tourSpotlight');
            
            // Special case for controls - adjust positioning
            let offsetY = 0;
            if (step.element === "#photonEnergy") {
                // For photon energy slider
                const controlGroup = targetElement.closest('.control-group');
                if (controlGroup) {
                    offsetY = -20; // Adjust upward to better align with the control
                }
            } else if (step.element === "#material") {
                // For material dropdown
                const controlGroup = targetElement.closest('.control-group');
                if (controlGroup) {
                    offsetY = -15; // Adjust upward to better align with the dropdown
                }
            }
            
            // Position spotlight
            if (step.spotlight) {
                spotlight.style.display = 'block';
                spotlight.style.width = `${step.width || rect.width}px`;
                spotlight.style.height = `${step.height || rect.height}px`;
                spotlight.style.top = `${rect.top + offsetY}px`; // Apply vertical offset if needed
                spotlight.style.left = `${rect.left}px`;
                spotlight.style.borderRadius = '8px';
                spotlight.style.pointerEvents = 'none'; // Ensure spotlight doesn't block interactions
                
                // Check if this step needs transparent background
                if (step.transparentBackground) {
                    document.getElementById('tourOverlay').style.background = 'transparent';
                    spotlight.style.boxShadow = '0 0 0 99999px rgba(0, 0, 0, 0)';
                    spotlight.style.border = '2px dashed rgba(99, 102, 241, 0.8)';
                } else {
                    // Reset to default
                    spotlight.style.border = 'none';
                }
            } else {
                spotlight.style.display = 'none';
            }
            
            // Add highlight class to the element
            targetElement.classList.add('highlight-element');
            
            // Position the popup based on specified position
            const popup = document.getElementById('tourPopup');
            switch (step.position) {
                case 'top':
                    popup.style.top = `${rect.top - popup.offsetHeight - 20}px`;
                    popup.style.left = `${rect.left + rect.width / 2}px`;
                    popup.style.transform = 'translateX(-50%)';
                    break;
                case 'bottom':
                    popup.style.top = `${rect.bottom + 20}px`;
                    popup.style.left = `${rect.left + rect.width / 2}px`;
                    popup.style.transform = 'translateX(-50%)';
                    break;
                case 'left':
                    popup.style.top = `${rect.top + rect.height / 2}px`;
                    popup.style.left = `${rect.left - popup.offsetWidth - 20}px`;
                    popup.style.transform = 'translateY(-50%)';
                    break;
                case 'right':
                    popup.style.top = `${rect.top + rect.height / 2}px`;
                    popup.style.left = `${rect.right + 20}px`;
                    popup.style.transform = 'translateY(-50%)';
                    break;
                default:
                    popup.style.top = '50%';
                    popup.style.left = '50%';
                    popup.style.transform = 'translate(-50%, -50%)';
            }
            
            // Ensure popup is within viewport
            const popupRect = popup.getBoundingClientRect();
            if (popupRect.left < 20) {
                popup.style.left = '20px';
                popup.style.transform = 'translateY(-50%)';
            }
            if (popupRect.right > window.innerWidth - 20) {
                popup.style.left = `${window.innerWidth - popup.offsetWidth - 20}px`;
                popup.style.transform = 'translateY(-50%)';
            }
            if (popupRect.top < 20) {
                popup.style.top = '20px';
                popup.style.transform = 'translateX(-50%)';
            }
            if (popupRect.bottom > window.innerHeight - 20) {
                popup.style.top = `${window.innerHeight - popup.offsetHeight - 20}px`;
                popup.style.transform = 'translateX(-50%)';
            }
        }
        
        // Function to clean up tour highlights
        function cleanupTourHighlights() {
            // Remove highlight class from all elements
            document.querySelectorAll('.highlight-element').forEach(el => {
                el.classList.remove('highlight-element');
            });
            
            // Hide spotlights
            document.getElementById('tourSpotlight').style.display = 'none';
            document.getElementById('tourSpotlightSecondary').style.display = 'none';
        }
        
        // Function to advance to the next tour step
        function nextTourStep() {
            if (currentTourStep < tourSteps.length - 1) {
                currentTourStep++;
                showTourStep();
            }
        }
        
        // Function to go back to the previous tour step
        function prevTourStep() {
            if (currentTourStep > 0) {
                currentTourStep--;
                showTourStep();
            }
        }
        
        // Function to skip the tour
        function skipTour() {
            tourActive = false;
            
            // Hide tour elements
            document.getElementById('tourOverlay').classList.remove('active');
            document.getElementById('tourPopup').classList.remove('active');
            document.getElementById('tourScore').classList.remove('active');
            
            // Reset pointer-events
            document.getElementById('tourOverlay').style.pointerEvents = '';
            
            // Clean up highlights
            cleanupTourHighlights();
        }
        
        // Function to finish the tour with achievement
        function finalizeTour() {
            // Complete the tour
            tourActive = false;
            
            // Hide tour elements
            document.getElementById('tourOverlay').classList.remove('active');
            document.getElementById('tourPopup').classList.remove('active');
            
            // Reset pointer-events
            document.getElementById('tourOverlay').style.pointerEvents = '';
            
            // Clean up highlights
            cleanupTourHighlights();
            
            // Show achievement
            showAchievement({
                title: "Tour Completed!",
                description: `You earned ${tourScore} points and learned ${conceptsLearned} photonics concepts!`
            });
        }
        
        // Function to show achievement popup
        function showAchievement(achievement) {
            document.getElementById('achievementTitle').textContent = achievement.title;
            document.getElementById('achievementDescription').textContent = achievement.description;
            document.getElementById('tourAchievements').classList.add('active');
        }
        
        // Function to close achievement popup
        function closeAchievement() {
            document.getElementById('tourAchievements').classList.remove('active');
        }
        
        // Function to update tour score display
        function updateTourScore() {
            document.getElementById('tourScoreValue').textContent = tourScore;
            document.getElementById('tourConceptsValue').textContent = `${conceptsLearned}/10`;
            document.getElementById('tourChallengesValue').textContent = `${challengeStats.completed}/3`;
        }
        
        // Function to toggle help panel
        function toggleHelp() {
            helpPanelVisible = !helpPanelVisible;
            const helpPanel = document.getElementById('helpPanel');
            
            if (helpPanelVisible) {
                helpPanel.classList.add('active');
            } else {
                helpPanel.classList.remove('active');
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize first module
            initAbsorptionModule();
            
            // Initialize challenge system
            generateNewQuestions();
            
            // Show legends by default after a short delay
            setTimeout(() => {
                const absorptionLegend = document.getElementById('absorption-legend');
                const absorptionQuickInfo = document.getElementById('absorption-quick-info');
                if (absorptionLegend) {
                    absorptionLegend.classList.add('visible');
                    if (absorptionQuickInfo) absorptionQuickInfo.classList.add('visible');
                    const toggleBtn = document.querySelector('#bandDiagram .legend-toggle');
                    if (toggleBtn) toggleBtn.classList.add('active');
                }
            }, 1000);
            
            // Add smooth transitions
            document.querySelectorAll('.module-content').forEach(module => {
                module.style.transition = 'opacity 0.3s ease-in-out';
            });
        });
    </script>
<script src="../assets/js/iframeResize.js"></script>
        
        </body>
</html>